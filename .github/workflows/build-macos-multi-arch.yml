name: Build Desktop App (macOS + Windows)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
    tags:
      - "*"
  pull_request:
    branches:
      - main

jobs:
  build-macos:
    strategy:
      matrix:
        include:
          # Apple Silicon (ARM64) - M1/M2/M3 èŠ¯ç‰‡
          - runner: macos-latest
            arch: arm64
            arch_name: "Apple Silicon"

          # Intel (x86_64) - æ—§æ¬¾ Mac
          - runner: macos-13
            arch: x86_64
            arch_name: "Intel"

    runs-on: ${{ matrix.runner }}

    name: Build for ${{ matrix.arch_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display build info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”¨ Build Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Runner: ${{ matrix.runner }}"
          echo "Target Architecture: ${{ matrix.arch_name }} (${{ matrix.arch }})"
          echo "System Architecture: $(uname -m)"
          echo "macOS Version: $(sw_vers -productVersion)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Verify icon file
        run: |
          if [ -f "favicon.icns" ]; then
            echo "âœ… Icon file found"
            ls -lh favicon.icns
          else
            echo "âŒ favicon.icns not found!"
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify Python architecture
        run: |
          echo "Python Architecture:"
          python3 -c "import platform; print(f'  Machine: {platform.machine()}')"
          python3 -c "import platform; print(f'  Processor: {platform.processor()}')"
          python3 -c "import struct; print(f'  Bits: {struct.calcsize(\"P\") * 8}-bit')"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-${{ matrix.arch }}-pip-${{ hashFiles('requirements-macos.txt') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements-macos.txt

      - name: Build with PyInstaller
        run: |
          echo "ğŸ”¨ Starting build for ${{ matrix.arch_name }}..."
          pyinstaller app-macos.spec --clean --noconfirm

      - name: Verify build
        run: |
          if [ -d "dist/Arkham Card Maker.app" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Build Successful"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "App Size: $(du -sh 'dist/Arkham Card Maker.app' | cut -f1)"
            echo "Architecture: ${{ matrix.arch }}"
            echo ""
            # éªŒè¯äºŒè¿›åˆ¶æ¶æ„
            echo "Binary Architecture:"
            file "dist/Arkham Card Maker.app/Contents/MacOS/Arkham Card Maker"
            lipo -info "dist/Arkham Card Maker.app/Contents/MacOS/Arkham Card Maker" || true
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ Build failed"
            exit 1
          fi

      - name: Install create-dmg
        run: |
          brew install create-dmg

      - name: Create DMG
        run: |
          DMG_NAME="Arkham-Card-Maker-${{ matrix.arch }}.dmg"
          echo "ğŸ“€ Creating DMG: $DMG_NAME"

          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§æ–‡ä»¶å’ŒæŒ‚è½½
          if [ -f "$DMG_NAME" ]; then
            echo "Removing existing DMG file..."
            rm -f "$DMG_NAME"
          fi

          # å¸è½½å¯èƒ½å·²æŒ‚è½½çš„åŒåå·
          if hdiutil info | grep -q "Arkham Card Maker"; then
            echo "Unmounting existing volume..."
            hdiutil detach "/Volumes/Arkham Card Maker" -force 2>/dev/null || true
          fi

          # ç­‰å¾…æ–‡ä»¶ç³»ç»Ÿç¨³å®š
          sleep 2

          create-dmg \
            --volname "Arkham Card Maker" \
            --volicon "favicon.icns" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "Arkham Card Maker.app" 200 190 \
            --hide-extension "Arkham Card Maker.app" \
            --app-drop-link 600 185 \
            --no-internet-enable \
            "$DMG_NAME" \
            "dist/Arkham Card Maker.app"

          echo "âœ… DMG created successfully"

      - name: Verify DMG
        run: |
          DMG_FILE="Arkham-Card-Maker-${{ matrix.arch }}.dmg"
          if [ -f "$DMG_FILE" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ DMG Information"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "File: $DMG_FILE"
            echo "Size: $(du -sh '$DMG_FILE' | cut -f1)"
            echo "Architecture: ${{ matrix.arch }}"
            echo "For: ${{ matrix.arch_name }}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ DMG not found!"
            exit 1
          fi

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: Arkham-Card-Maker-${{ matrix.arch }}
          path: Arkham-Card-Maker-${{ matrix.arch }}.dmg
          retention-days: 30
          if-no-files-found: error

  build-windows:
    runs-on: windows-latest

    name: Build for Windows (x86_64)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          pyinstaller app.spec --clean --noconfirm

      - name: Prepare Windows directory
        shell: pwsh
        run: |
          if (Test-Path "dist/Arkham Card Maker") {
            Remove-Item "dist/Arkham Card Maker" -Recurse -Force
          }
          if (-Not (Test-Path "dist/ArkhamHomebrew")) {
            Write-Error "dist/ArkhamHomebrew not found after build"
          }
          Rename-Item "dist/ArkhamHomebrew" "Arkham Card Maker"

      - name: Create Windows ZIP package
        shell: pwsh
        run: |
          Compress-Archive -Path "dist/Arkham Card Maker\*" -DestinationPath "Arkham-Card-Maker-win.zip" -Force

      - name: Upload Windows ZIP
        uses: actions/upload-artifact@v4
        with:
          name: Arkham-Card-Maker-win
          path: Arkham-Card-Maker-win.zip
          retention-days: 30
          if-no-files-found: error

  build-linux:
    strategy:
      matrix:
        include:
          # Debian ç³»åˆ— - ç”Ÿæˆ .deb åŒ…ï¼ˆé€‚ç”¨äº Ubuntuã€Mintã€Debian åŠå…¶è¡ç”Ÿç‰ˆï¼‰
          - distro: debian
            runner: ubuntu-22.04
            distro_name: "Debian/Ubuntu/Mint"
            distro_version: "Debian 11+, Ubuntu 22.04+, Mint 21+"
            pkg_format: deb
            pkg_manager: apt
            dependencies: "libgtk-3-0, libwebkit2gtk-4.0-37, libayatana-appindicator3-1, gir1.2-gtk-3.0, gir1.2-webkit2-4.0, python3-gi, python3-gi-cairo"
            install_cmd: |
              sudo apt-get update
              sudo apt-get install -y \
                python3 python3-pip python3-dev \
                libgtk-3-0 libwebkit2gtk-4.0-37 \
                libayatana-appindicator3-1 gir1.2-ayatanaappindicator3-0.1 \
                python3-gi python3-gi-cairo gir1.2-gtk-3.0 gir1.2-webkit2-4.0 \
                libgirepository1.0-dev libcairo2-dev pkg-config \
                binutils patchelf ruby ruby-dev build-essential
              sudo gem install --no-document fpm

          # Fedora ç³»åˆ— - ç”Ÿæˆ .rpm åŒ…ï¼ˆé€‚ç”¨äº Fedoraã€RHELã€CentOSï¼‰
          - distro: fedora
            runner: ubuntu-22.04
            distro_name: "Fedora/RHEL/CentOS"
            distro_version: "Fedora 38+, RHEL 9+, CentOS Stream 9+"
            pkg_format: rpm
            pkg_manager: dnf
            dependencies: "gtk3, webkit2gtk4.1, gobject-introspection, python3-gobject, python3-cairo"
            install_cmd: |
              # è®¾ç½® UTF-8 locale ä»¥æ”¯æŒä¸­æ–‡å­—ç¬¦
              dnf install -y glibc-langpack-en
              export LANG=en_US.UTF-8
              export LC_ALL=en_US.UTF-8

              dnf install -y \
                python3 python3-pip python3-devel \
                gtk3 webkit2gtk4.1 \
                python3-gobject python3-cairo gobject-introspection-devel cairo-devel \
                binutils patchelf \
                gcc gcc-c++ make \
                ruby ruby-devel rubygems rpm-build
              gem install --no-document fpm

          # é€šç”¨ Linux - ç”Ÿæˆ tar.gzï¼ˆé€‚ç”¨äºæ‰€æœ‰å…¶ä»–å‘è¡Œç‰ˆï¼‰
          - distro: generic
            runner: ubuntu-22.04
            distro_name: "Generic Linux"
            distro_version: "All distributions (Arch, openSUSE, Gentoo, etc.)"
            pkg_format: tar.gz
            pkg_manager: manual
            dependencies: ""
            install_cmd: |
              sudo apt-get update
              sudo apt-get install -y \
                python3 python3-pip python3-dev \
                libgtk-3-0 libwebkit2gtk-4.0-37 \
                libayatana-appindicator3-1 gir1.2-ayatanaappindicator3-0.1 \
                python3-gi python3-gi-cairo gir1.2-gtk-3.0 gir1.2-webkit2-4.0 \
                libgirepository1.0-dev libcairo2-dev pkg-config \
                binutils patchelf

    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.distro == 'fedora' && 'fedora:latest' || null }}

    name: Build for ${{ matrix.distro_name }} (${{ matrix.distro_version }})

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display build info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”¨ Build Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Distribution: ${{ matrix.distro_name }}"
          echo "Version: ${{ matrix.distro_version }}"
          echo "Package Format: ${{ matrix.pkg_format }}"
          echo "Package Manager: ${{ matrix.pkg_manager }}"
          echo "Runner: ${{ matrix.runner }}"
          echo "System Architecture: $(uname -m)"
          echo "Kernel Version: $(uname -r)"
          if command -v lsb_release &> /dev/null; then
            echo "OS Info: $(lsb_release -d | cut -f2-)"
          elif [ -f /etc/os-release ]; then
            echo "OS Info: $(grep PRETTY_NAME /etc/os-release | cut -d'"' -f2)"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Install system dependencies
        run: |
          echo "Installing dependencies for ${{ matrix.distro_name }}..."
          ${{ matrix.install_cmd }}

      - name: Set up Python (non-container)
        if: matrix.distro != 'fedora'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Configure Python to access system gi modules
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”§ Configuring Python environment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # æ ¹æ®å‘è¡Œç‰ˆç¡®å®šç³»ç»Ÿ site-packages è·¯å¾„
          if [ "${{ matrix.distro }}" = "fedora" ]; then
            # Fedora ä½¿ç”¨ç³»ç»Ÿ Pythonï¼ŒæŸ¥æ‰¾ site-packages
            SYSTEM_SITE_PACKAGES=$(python3 -c "import sys; import os; paths = [p for p in sys.path if 'site-packages' in p and os.path.exists(p)]; print(paths[0] if paths else '/usr/lib64/python3.11/site-packages')")
          else
            # Debian/Ubuntu æŸ¥æ‰¾ dist-packagesï¼ˆç³»ç»ŸåŒ…ä½ç½®ï¼‰
            SYSTEM_SITE_PACKAGES=$(/usr/bin/python3 -c "import sys; print([p for p in sys.path if 'dist-packages' in p][0])" 2>/dev/null || echo "/usr/lib/python3/dist-packages")
          fi

          echo "System site-packages: $SYSTEM_SITE_PACKAGES"

          # å°†ç³»ç»Ÿ site-packages æ·»åŠ åˆ° PYTHONPATHï¼ˆå¯¹åç»­æ‰€æœ‰æ­¥éª¤ç”Ÿæ•ˆï¼‰
          echo "PYTHONPATH=$SYSTEM_SITE_PACKAGES:$PYTHONPATH" >> $GITHUB_ENV

          # éªŒè¯è·¯å¾„å­˜åœ¨
          if [ -d "$SYSTEM_SITE_PACKAGES/gi" ]; then
            echo "âœ… Found gi module at: $SYSTEM_SITE_PACKAGES/gi"
          else
            echo "âš ï¸  Warning: gi module not found at expected location"
            echo "   Searching for gi module..."
            find /usr/lib* -name "gi" -type d 2>/dev/null | head -5 || true
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Cache pip packages
        if: matrix.distro != 'fedora'
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-${{ matrix.distro }}-py311-pip-${{ hashFiles('requirements-linux.txt') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.distro }}-py311-pip-

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install pyinstaller
          pip3 install -r requirements-linux.txt

      - name: Verify GTK and GI installation
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Verifying GTK and PyGObject installation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # æ˜¾ç¤º Python ç¯å¢ƒä¿¡æ¯
          echo "Python version:"
          python3 --version
          echo ""
          echo "Python executable:"
          command -v python3
          echo ""
          echo "PYTHONPATH:"
          echo "$PYTHONPATH"
          echo ""
          echo "Python sys.path:"
          python3 -c "import sys; print('\n'.join(sys.path))"
          echo ""

          # éªŒè¯ gi æ¨¡å—å¯å¯¼å…¥
          python3 -c "import gi; print('âœ… gi module imported successfully')"
          python3 -c "import gi; print('   gi module path:', gi.__file__)"

          # éªŒè¯ GTK 3.0 å¯ç”¨
          python3 -c "import gi; gi.require_version('Gtk', '3.0'); from gi.repository import Gtk; print('âœ… GTK 3.0 available')"

          # éªŒè¯ WebKit2 4.0 å¯ç”¨
          python3 -c "import gi; gi.require_version('WebKit2', '4.0'); from gi.repository import WebKit2; print('âœ… WebKit2 4.0 available')"

          # éªŒè¯ cairo å¯ç”¨
          python3 -c "import cairo; print('âœ… cairo module available')"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Build with PyInstaller
        run: |
          echo "ğŸ”¨ Starting build for ${{ matrix.distro_name }}..."
          pyinstaller app-linux.spec --clean --noconfirm

      - name: Verify build
        run: |
          if [ -d "dist/Arkham Card Maker" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Build Successful"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Distribution: ${{ matrix.distro_name }}"
            echo "App Size: $(du -sh 'dist/Arkham Card Maker' | cut -f1)"
            echo "Architecture: x86_64"
            echo ""
            echo "Binary Information:"
            file "dist/Arkham Card Maker/Arkham Card Maker"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ Build failed"
            exit 1
          fi

      # åŸç”ŸåŒ…æ„å»ºï¼ˆ.deb æˆ– .rpmï¼‰
      - name: Prepare package structure (native packages)
        if: matrix.pkg_format != 'tar.gz'
        run: |
          mkdir -p package/opt/arkham-card-maker
          mkdir -p package/usr/share/applications
          mkdir -p package/usr/share/pixmaps

          # å¤åˆ¶åº”ç”¨æ–‡ä»¶
          cp -r "dist/Arkham Card Maker"/* package/opt/arkham-card-maker/

          # å¤åˆ¶å›¾æ ‡
          cp favicon.png package/usr/share/pixmaps/arkham-card-maker.png
          cp favicon.png package/opt/arkham-card-maker/favicon.png

          # å¤åˆ¶ .desktop æ–‡ä»¶å¹¶è®¾ç½®æƒé™
          cp arkham-card-maker.desktop package/usr/share/applications/
          chmod 644 package/usr/share/applications/arkham-card-maker.desktop

          # å‡†å¤‡ post-install è„šæœ¬
          mkdir -p scripts
          cp .github/scripts/postinstall.sh scripts/
          chmod 755 scripts/postinstall.sh

          echo "âœ… Package structure prepared"

      - name: Create native package (${{ matrix.pkg_format }})
        if: matrix.pkg_format != 'tar.gz'
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="1.0.0"
          fi

          echo "Creating ${{ matrix.pkg_format }} package version $VERSION..."

          # ä¸º Fedora container è®¾ç½® UTF-8 ç¯å¢ƒå˜é‡ï¼ˆè§£å†³ä¸­æ–‡ç¼–ç é—®é¢˜ï¼‰
          if [ "${{ matrix.distro }}" = "fedora" ]; then
            export LANG=en_US.UTF-8
            export LC_ALL=en_US.UTF-8
            echo "Set UTF-8 locale for RPM package creation"
          fi

          # å°†é€—å·åˆ†éš”çš„ä¾èµ–è½¬æ¢ä¸º fpm çš„ --depends å‚æ•°
          DEPS="${{ matrix.dependencies }}"
          DEPS_ARGS=""
          IFS=',' read -ra DEP_ARRAY <<< "$DEPS"
          for dep in "${DEP_ARRAY[@]}"; do
            dep=$(echo "$dep" | xargs)  # å»é™¤ç©ºæ ¼
            DEPS_ARGS="$DEPS_ARGS --depends $dep"
          done

          fpm -s dir -t ${{ matrix.pkg_format }} \
            -n arkham-card-maker \
            -v "$VERSION" \
            --vendor "Arkham Card Maker Team" \
            --maintainer "Arkham Card Maker <support@arkham-card-maker.com>" \
            --description "Create custom cards for Arkham Horror LCG" \
            --url "https://github.com/xziying44/arkham-homebrew" \
            --license "MIT" \
            --architecture x86_64 \
            $DEPS_ARGS \
            --after-install scripts/postinstall.sh \
            --after-remove /dev/null \
            -C package \
            opt usr

          echo "âœ… ${{ matrix.pkg_format }} package created successfully"

      - name: Verify native package
        if: matrix.pkg_format != 'tar.gz'
        run: |
          PACKAGE_FILE=$(ls arkham-card-maker*.${{ matrix.pkg_format }})
          if [ -f "$PACKAGE_FILE" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ ${{ matrix.distro_name }} Package Information"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "File: $PACKAGE_FILE"
            echo "Size: $(du -sh '$PACKAGE_FILE' | cut -f1)"
            echo "Format: ${{ matrix.pkg_format }}"
            echo "Distribution: ${{ matrix.distro_name }}"
            echo "Architecture: x86_64"
            echo ""
            echo "Package Contents:"
            if [ "${{ matrix.pkg_format }}" = "deb" ]; then
              dpkg -c "$PACKAGE_FILE" | head -20
            else
              rpm -qlp "$PACKAGE_FILE" | head -20
            fi
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ Package not found!"
            exit 1
          fi

      - name: Rename native package
        if: matrix.pkg_format != 'tar.gz'
        run: |
          PACKAGE_FILE=$(ls arkham-card-maker*.${{ matrix.pkg_format }})
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="1.0.0"
          fi
          NEW_NAME="arkham-card-maker_${VERSION}_${{ matrix.distro }}.${{ matrix.pkg_format }}"
          mv "$PACKAGE_FILE" "$NEW_NAME"
          echo "âœ… Renamed to: $NEW_NAME"

      # é€šç”¨ tar.gz æ„å»º
      - name: Create generic tar.gz package
        if: matrix.pkg_format == 'tar.gz'
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="1.0.0"
          fi

          cd dist
          tar -czf "../arkham-card-maker_${VERSION}_linux.tar.gz" "Arkham Card Maker"
          cd ..
          echo "âœ… Generic tar.gz created successfully"

      - name: Verify tar.gz package
        if: matrix.pkg_format == 'tar.gz'
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="1.0.0"
          fi
          PACKAGE_FILE="arkham-card-maker_${VERSION}_linux.tar.gz"
          if [ -f "$PACKAGE_FILE" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Generic Linux Package Information"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "File: $PACKAGE_FILE"
            echo "Size: $(du -sh '$PACKAGE_FILE' | cut -f1)"
            echo "Format: tar.gz"
            echo "Compatible: All Linux distributions"
            echo "Architecture: x86_64"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ tar.gz not found!"
            exit 1
          fi

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: arkham-card-maker-${{ matrix.distro }}
          path: |
            arkham-card-maker_*_${{ matrix.distro }}.${{ matrix.pkg_format }}
            arkham-card-maker_*_linux.tar.gz
          retention-days: 30
          if-no-files-found: error

  # åˆ›å»ºæ„å»ºæ‘˜è¦
  build-summary:
    needs:
      - build-macos
      - build-linux
    runs-on: ubuntu-latest

    steps:
      - name: Create Build Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ğŸ‰ æ„å»ºå®Œæˆ

          ## ğŸ“¥ ä¸‹è½½å®‰è£…åŒ…

          æ‰€æœ‰ç‰ˆæœ¬å·²æˆåŠŸæ„å»ºï¼Œè¯·æ ¹æ®ä½ çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„å®‰è£…åŒ…ï¼š

          ### ğŸ macOS - Apple Silicon (ARM64)
          **é€‚ç”¨äºï¼š** M1ã€M2ã€M3 èŠ¯ç‰‡çš„ Macï¼ˆ2020 å¹´åº•åŠä»¥åï¼‰

          **ä¸‹è½½ï¼š** `Arkham-Card-Maker-arm64.dmg`

          ---

          ### ğŸ’» macOS - Intel (x86_64)
          **é€‚ç”¨äºï¼š** Intel å¤„ç†å™¨çš„ Macï¼ˆ2020 å¹´åŠä¹‹å‰ï¼‰

          **ä¸‹è½½ï¼š** `Arkham-Card-Maker-x86_64.dmg`

          ---

          ### ğŸªŸ Windows (x86_64)
          **é€‚ç”¨äºï¼š** Windows 10/11ï¼ˆ64ä½ï¼‰

          **ä¸‹è½½ï¼š** `Arkham-Card-Maker-win.zip`

          ---

          ### ğŸ§ Linux - Debian/Ubuntu/Mint (æ¨è)
          **é€‚ç”¨äºï¼š** Debian 11+, Ubuntu 22.04+, Linux Mint 21+ åŠæ‰€æœ‰ Debian ç³»è¡ç”Ÿç‰ˆ

          **ä¸‹è½½ï¼š** `arkham-card-maker_xxx_debian.deb` (åŸç”ŸåŒ…ï¼Œè‡ªåŠ¨å®‰è£…ä¾èµ–)

          **å®‰è£…æ–¹æ³•ï¼š**
          ```bash
          # æ–¹æ³•1ï¼šå›¾å½¢ç•Œé¢ - åŒå‡» .deb æ–‡ä»¶ï¼ŒæŒ‰æç¤ºå®‰è£…

          # æ–¹æ³•2ï¼šå‘½ä»¤è¡Œ
          sudo dpkg -i arkham-card-maker_*_debian.deb
          sudo apt-get install -f  # è‡ªåŠ¨å®‰è£…ä¾èµ–ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰
          ```

          **æ‰‹åŠ¨å®‰è£…ä¾èµ–ï¼ˆå¦‚éœ€è¦ï¼‰ï¼š**
          ```bash
          # Ubuntu 22.04+ / Debian 11+
          sudo apt-get install libgtk-3-0 libwebkit2gtk-4.0-37 libayatana-appindicator3-1 \
            gir1.2-gtk-3.0 gir1.2-webkit2-4.0 python3-gi python3-gi-cairo
          ```

          **å¸è½½ï¼š**
          ```bash
          sudo apt-get remove arkham-card-maker
          ```

          ---

          ### ğŸ© Linux - Fedora/RHEL/CentOS (æ¨è)
          **é€‚ç”¨äºï¼š** Fedora 38+, RHEL 9+, CentOS Stream 9+ åŠ Red Hat ç³»è¡ç”Ÿç‰ˆ

          **ä¸‹è½½ï¼š** `arkham-card-maker_xxx_fedora.rpm` (åŸç”ŸåŒ…ï¼Œè‡ªåŠ¨å®‰è£…ä¾èµ–)

          **å®‰è£…æ–¹æ³•ï¼š**
          ```bash
          # æ–¹æ³•1ï¼šå›¾å½¢ç•Œé¢ - åŒå‡» .rpm æ–‡ä»¶ï¼ŒæŒ‰æç¤ºå®‰è£…

          # æ–¹æ³•2ï¼šå‘½ä»¤è¡Œ
          sudo dnf install arkham-card-maker_*_fedora.rpm
          ```

          **å¸è½½ï¼š**
          ```bash
          sudo dnf remove arkham-card-maker
          ```

          ---

          ### ğŸ”§ Linux - é€šç”¨ç‰ˆæœ¬ (æ‰€æœ‰å‘è¡Œç‰ˆ)
          **é€‚ç”¨äºï¼š** Archã€openSUSEã€Gentooã€Slackware ç­‰å…¶ä»– Linux å‘è¡Œç‰ˆ

          **ä¸‹è½½ï¼š** `arkham-card-maker_xxx_linux.tar.gz` (æ‰‹åŠ¨å®‰è£…)

          **å®‰è£…æ–¹æ³•ï¼š**
          ```bash
          # 1. è§£å‹
          tar -xzf arkham-card-maker_*_linux.tar.gz

          # 2. è¿›å…¥ç›®å½•
          cd "Arkham Card Maker"

          # 3. å®‰è£…ä¾èµ–ï¼ˆæ ¹æ®ä½ çš„å‘è¡Œç‰ˆé€‰æ‹©å‘½ä»¤ï¼‰
          # Arch Linux:
          sudo pacman -S gtk3 webkit2gtk python-gobject python-cairo

          # openSUSE:
          sudo zypper install gtk3 webkit2gtk3 python3-gobject python3-cairo

          # Gentoo:
          sudo emerge --ask dev-python/pygobject dev-python/pycairo x11-libs/gtk+ net-libs/webkit-gtk

          # 4. è¿è¡Œ
          ./Arkham\ Card\ Maker
          ```

          ---

          ## â“ å¦‚ä½•ç¡®å®šæˆ‘çš„ Mac èŠ¯ç‰‡ç±»å‹ï¼Ÿ

          1. ç‚¹å‡»å·¦ä¸Šè§’  **Apple èœå•**
          2. é€‰æ‹© **å…³äºæœ¬æœº**
          3. æŸ¥çœ‹ **èŠ¯ç‰‡** æˆ– **å¤„ç†å™¨** ä¸€æ ï¼š
             - æ˜¾ç¤º "Apple M1/M2/M3" â†’ ä¸‹è½½ **ARM64** ç‰ˆæœ¬
             - æ˜¾ç¤º "Intel Core" â†’ ä¸‹è½½ **x86_64** ç‰ˆæœ¬

          ## ğŸ“¦ å®‰è£…è¯´æ˜

          ### macOS
          1. ä¸‹è½½å¯¹åº”æ¶æ„çš„ DMG æ–‡ä»¶
          2. åŒå‡»æ‰“å¼€ DMG
          3. å°† **Arkham Card Maker.app** æ‹–æ‹½åˆ° **Applications** æ–‡ä»¶å¤¹
          4. é¦–æ¬¡è¿è¡Œæ—¶ï¼Œå³é”®ç‚¹å‡»åº”ç”¨ â†’ é€‰æ‹© **æ‰“å¼€**ï¼ˆç»•è¿‡æœªç­¾åè­¦å‘Šï¼‰

          ### Windows
          1. ä¸‹è½½ ZIP æ–‡ä»¶
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `Arkham Card Maker.exe`
          4. å¦‚é‡åˆ° SmartScreen è­¦å‘Šï¼Œç‚¹å‡»"æ›´å¤šä¿¡æ¯" â†’ "ä»è¦è¿è¡Œ"

          ### Linuxï¼ˆåŸç”ŸåŒ… - å¼ºçƒˆæ¨èï¼‰

          **ä¼˜åŠ¿ï¼š**
          - âœ… è‡ªåŠ¨å®‰è£…æ‰€éœ€ä¾èµ–åº“
          - âœ… è‡ªåŠ¨æ·»åŠ åˆ°ç³»ç»Ÿåº”ç”¨èœå•
          - âœ… å¯é€šè¿‡ç³»ç»ŸåŒ…ç®¡ç†å™¨å¸è½½å’Œæ›´æ–°

          **ä½¿ç”¨æ–¹æ³•ï¼š**
          1. **Debian ç³»ç”¨æˆ·**ï¼ˆUbuntu/Mintï¼‰ï¼šä¸‹è½½ `.deb` åŒ…
          2. **Red Hat ç³»ç”¨æˆ·**ï¼ˆFedora/RHELï¼‰ï¼šä¸‹è½½ `.rpm` åŒ…
          3. åŒå‡»å®‰è£…åŒ…ï¼ŒæŒ‰ç³»ç»Ÿæç¤ºå®‰è£…
          4. å®‰è£…å®Œæˆåï¼Œåœ¨åº”ç”¨èœå•ä¸­æœç´¢ "Arkham Card Maker" å³å¯è¿è¡Œ
          5. æˆ–åœ¨ç»ˆç«¯è¿è¡Œï¼š`arkham-card-maker`

          **é€šç”¨ç‰ˆæœ¬ï¼ˆtar.gzï¼‰é€‚ç”¨åœºæ™¯ï¼š**
          - ä½¿ç”¨å…¶ä»–å‘è¡Œç‰ˆï¼ˆArchã€openSUSE ç­‰ï¼‰
          - ä¸æƒ³ä½¿ç”¨ç³»ç»ŸåŒ…ç®¡ç†å™¨
          - éœ€è¦ä¾¿æºå¼å®‰è£…
          - éœ€è¦å¤šç‰ˆæœ¬å…±å­˜

          ---

          *æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF

  release:
    needs:
      - build-macos
      - build-windows
      - build-linux
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    env:
      VERSION: ${{ github.ref_name }}

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts structure
        run: |
          echo "Downloaded artifacts:"
          ls -R artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release

          # macOS
          mv "artifacts/Arkham-Card-Maker-arm64/Arkham-Card-Maker-arm64.dmg" \
             "release/Arkham-Card-Maker-${VERSION}-macos-arm64.dmg"
          mv "artifacts/Arkham-Card-Maker-x86_64/Arkham-Card-Maker-x86_64.dmg" \
             "release/Arkham-Card-Maker-${VERSION}-macos-x86_64.dmg"

          # Windows
          mv "artifacts/Arkham-Card-Maker-win/Arkham-Card-Maker-win.zip" \
             "release/Arkham-Card-Maker-${VERSION}-win.zip"

          # Linux - Debian (.deb)
          DEBIAN_DEB=$(find artifacts/arkham-card-maker-debian -name "*.deb")
          cp "$DEBIAN_DEB" "release/arkham-card-maker-${VERSION}-debian.deb"

          # Linux - Fedora (.rpm)
          FEDORA_RPM=$(find artifacts/arkham-card-maker-fedora -name "*.rpm")
          cp "$FEDORA_RPM" "release/arkham-card-maker-${VERSION}-fedora.rpm"

          # Linux - Generic (tar.gz)
          GENERIC_TAR=$(find artifacts/arkham-card-maker-generic -name "*_linux.tar.gz")
          cp "$GENERIC_TAR" "release/arkham-card-maker-${VERSION}-linux.tar.gz"

          echo "Release assets prepared:"
          ls -lh release/

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            release/Arkham-Card-Maker-${{ env.VERSION }}-macos-arm64.dmg
            release/Arkham-Card-Maker-${{ env.VERSION }}-macos-x86_64.dmg
            release/Arkham-Card-Maker-${{ env.VERSION }}-win.zip
            release/arkham-card-maker-${{ env.VERSION }}-debian.deb
            release/arkham-card-maker-${{ env.VERSION }}-fedora.rpm
            release/arkham-card-maker-${{ env.VERSION }}-linux.tar.gz
          body: |
            ## ğŸ‰ Arkham Card Maker ${{ env.VERSION }}

            ### ğŸ“¦ å®‰è£…åŒ…ä¸‹è½½

            #### macOS
            - **Apple Silicon (M1/M2/M3)**: `Arkham-Card-Maker-${{ env.VERSION }}-macos-arm64.dmg`
            - **Intel**: `Arkham-Card-Maker-${{ env.VERSION }}-macos-x86_64.dmg`

            #### Windows
            - **Windows 10/11 (64ä½)**: `Arkham-Card-Maker-${{ env.VERSION }}-win.zip`

            #### Linux

            **åŸç”ŸåŒ…ï¼ˆæ¨èï¼‰ï¼š**
            - **Debian/Ubuntu/Mint**: `arkham-card-maker-${{ env.VERSION }}-debian.deb`
            - **Fedora/RHEL/CentOS**: `arkham-card-maker-${{ env.VERSION }}-fedora.rpm`

            **é€šç”¨ç‰ˆæœ¬ï¼š**
            - **æ‰€æœ‰ Linux å‘è¡Œç‰ˆ**: `arkham-card-maker-${{ env.VERSION }}-linux.tar.gz`

            ---

            ### ğŸ“– å®‰è£…è¯´æ˜

            #### Linux ç”¨æˆ·

            **Debian/Ubuntu/Mint (æ¨èåŸç”ŸåŒ…)**:
            ```bash
            sudo dpkg -i arkham-card-maker-${{ env.VERSION }}-debian.deb
            sudo apt-get install -f  # è‡ªåŠ¨å®‰è£…ä¾èµ–
            ```

            **Fedora/RHEL/CentOS (æ¨èåŸç”ŸåŒ…)**:
            ```bash
            sudo dnf install arkham-card-maker-${{ env.VERSION }}-fedora.rpm
            ```

            **å…¶ä»–å‘è¡Œç‰ˆï¼ˆé€šç”¨ tar.gzï¼‰**:
            ```bash
            tar -xzf arkham-card-maker-${{ env.VERSION }}-linux.tar.gz
            cd "Arkham Card Maker"

            # å®‰è£…ä¾èµ–ï¼ˆæ ¹æ®ä½ çš„å‘è¡Œç‰ˆï¼‰
            # Arch: sudo pacman -S gtk3 webkit2gtk python-gobject python-cairo
            # openSUSE: sudo zypper install gtk3 webkit2gtk3 python3-gobject python3-cairo

            ./Arkham\ Card\ Maker
            ```

            å®‰è£…ååœ¨åº”ç”¨èœå•æœç´¢ "Arkham Card Maker" å³å¯è¿è¡Œã€‚

            ---

            ### âœ¨ æ–°ç‰¹æ€§
            - Linux åŸç”ŸåŒ…æ”¯æŒï¼ˆ.deb å’Œ .rpmï¼‰
            - è¦†ç›–æ›´å¤š Linux å‘è¡Œç‰ˆ
            - è‡ªåŠ¨ä¾èµ–å®‰è£…
            - ç³»ç»Ÿèœå•é›†æˆ

            ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
            - **Ubuntu/Debian**: Ubuntu 22.04+, Debian 11+
            - **Fedora/RHEL**: Fedora 38+, RHEL 9+
            - **å…¶ä»–**: ä»»ä½•ç°ä»£ Linux å‘è¡Œç‰ˆï¼ˆä½¿ç”¨é€šç”¨ tar.gzï¼‰

            ---
            *å®Œæ•´å®‰è£…æ–‡æ¡£è¯·æŸ¥çœ‹é¡¹ç›® README*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
