name: Build macOS App (Multi-Architecture)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

jobs:
  build-macos:
    strategy:
      matrix:
        include:
          # Apple Silicon (ARM64) - M1/M2/M3 èŠ¯ç‰‡
          - runner: macos-latest
            arch: arm64
            arch_name: "Apple Silicon"

          # Intel (x86_64) - æ—§æ¬¾ Mac
          - runner: macos-13
            arch: x86_64
            arch_name: "Intel"

    runs-on: ${{ matrix.runner }}

    name: Build for ${{ matrix.arch_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display build info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”¨ Build Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Runner: ${{ matrix.runner }}"
          echo "Target Architecture: ${{ matrix.arch_name }} (${{ matrix.arch }})"
          echo "System Architecture: $(uname -m)"
          echo "macOS Version: $(sw_vers -productVersion)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Verify icon file
        run: |
          if [ -f "favicon.icns" ]; then
            echo "âœ… Icon file found"
            ls -lh favicon.icns
          else
            echo "âŒ favicon.icns not found!"
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify Python architecture
        run: |
          echo "Python Architecture:"
          python3 -c "import platform; print(f'  Machine: {platform.machine()}')"
          python3 -c "import platform; print(f'  Processor: {platform.processor()}')"
          python3 -c "import struct; print(f'  Bits: {struct.calcsize(\"P\") * 8}-bit')"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-${{ matrix.arch }}-pip-${{ hashFiles('requirements-macos.txt') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements-macos.txt

      - name: Verify critical packages
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¦ Installed Packages"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          python -c "import flask; print(f'Flask: {flask.__version__}')"
          python -c "import webview; print(f'PyWebView: {webview.__version__}')"
          python -c "import PIL; print(f'Pillow: {PIL.__version__}')"
          python -c "import numpy; print(f'NumPy: {numpy.__version__}')"
          python -c "import requests; print(f'Requests: {requests.__version__}')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Build with PyInstaller
        run: |
          echo "ðŸ”¨ Starting build for ${{ matrix.arch_name }}..."
          pyinstaller app-macos.spec --clean --noconfirm

      - name: Verify build
        run: |
          if [ -d "dist/Arkham Card Maker.app" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Build Successful"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "App Size: $(du -sh 'dist/Arkham Card Maker.app' | cut -f1)"
            echo "Architecture: ${{ matrix.arch }}"
            echo ""
            # éªŒè¯äºŒè¿›åˆ¶æž¶æž„
            echo "Binary Architecture:"
            file "dist/Arkham Card Maker.app/Contents/MacOS/Arkham Card Maker"
            lipo -info "dist/Arkham Card Maker.app/Contents/MacOS/Arkham Card Maker" || true
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ Build failed"
            exit 1
          fi

      - name: Install create-dmg
        run: |
          brew install create-dmg

      - name: Create DMG
        run: |
          DMG_NAME="Arkham-Card-Maker-${{ matrix.arch }}.dmg"
          echo "ðŸ“€ Creating DMG: $DMG_NAME"
          
          create-dmg \
            --volname "Arkham Card Maker" \
            --volicon "favicon.icns" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "Arkham Card Maker.app" 200 190 \
            --hide-extension "Arkham Card Maker.app" \
            --app-drop-link 600 185 \
            --no-internet-enable \
            "$DMG_NAME" \
            "dist/Arkham Card Maker.app"
          
          echo "âœ… DMG created successfully"

      - name: Verify DMG
        run: |
          DMG_FILE="Arkham-Card-Maker-${{ matrix.arch }}.dmg"
          if [ -f "$DMG_FILE" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“¦ DMG Information"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "File: $DMG_FILE"
            echo "Size: $(du -sh '$DMG_FILE' | cut -f1)"
            echo "Architecture: ${{ matrix.arch }}"
            echo "For: ${{ matrix.arch_name }}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ DMG not found!"
            exit 1
          fi

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: Arkham-Card-Maker-${{ matrix.arch }}
          path: Arkham-Card-Maker-${{ matrix.arch }}.dmg
          retention-days: 30
          if-no-files-found: error

  # åˆ›å»ºæž„å»ºæ‘˜è¦
  build-summary:
    needs: build-macos
    runs-on: ubuntu-latest

    steps:
      - name: Create Build Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸŽ‰ macOS æž„å»ºå®Œæˆ
          
          ## ðŸ“¥ ä¸‹è½½å®‰è£…åŒ…
          
          ä¸¤ä¸ªç‰ˆæœ¬å·²æˆåŠŸæž„å»ºï¼Œè¯·æ ¹æ®ä½ çš„ Mac èŠ¯ç‰‡ç±»åž‹é€‰æ‹©å¯¹åº”çš„ DMG æ–‡ä»¶ï¼š
          
          ### ðŸŽ Apple Silicon (ARM64)
          **é€‚ç”¨äºŽï¼š** M1ã€M2ã€M3 èŠ¯ç‰‡çš„ Macï¼ˆ2020 å¹´åº•åŠä»¥åŽï¼‰
          
          **ä¸‹è½½ï¼š** `Arkham-Card-Maker-arm64`
          
          ---
          
          ### ðŸ’» Intel (x86_64)
          **é€‚ç”¨äºŽï¼š** Intel å¤„ç†å™¨çš„ Macï¼ˆ2020 å¹´åŠä¹‹å‰ï¼‰
          
          **ä¸‹è½½ï¼š** `Arkham-Card-Maker-x86_64`
          
          ---
          
          ## â“ å¦‚ä½•ç¡®å®šæˆ‘çš„ Mac èŠ¯ç‰‡ç±»åž‹ï¼Ÿ
          
          1. ç‚¹å‡»å·¦ä¸Šè§’  **Apple èœå•**
          2. é€‰æ‹© **å…³äºŽæœ¬æœº**
          3. æŸ¥çœ‹ **èŠ¯ç‰‡** æˆ– **å¤„ç†å™¨** ä¸€æ ï¼š
             - æ˜¾ç¤º "Apple M1/M2/M3" â†’ ä¸‹è½½ **ARM64** ç‰ˆæœ¬
             - æ˜¾ç¤º "Intel Core" â†’ ä¸‹è½½ **x86_64** ç‰ˆæœ¬
          
          ## ðŸ“¦ å®‰è£…æ–¹æ³•
          
          1. ä¸‹è½½å¯¹åº”æž¶æž„çš„ DMG æ–‡ä»¶
          2. åŒå‡»æ‰“å¼€ DMG
          3. å°† **Arkham Card Maker.app** æ‹–æ‹½åˆ° **Applications** æ–‡ä»¶å¤¹
          4. é¦–æ¬¡è¿è¡Œæ—¶ï¼Œå³é”®ç‚¹å‡»åº”ç”¨ â†’ é€‰æ‹© **æ‰“å¼€**ï¼ˆç»•è¿‡æœªç­¾åè­¦å‘Šï¼‰
          
          ---
          
          *æž„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF
