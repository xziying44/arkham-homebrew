name: Build Desktop App (macOS + Windows)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
    tags:
      - "*"
  pull_request:
    branches:
      - main

jobs:
  build-macos:
    strategy:
      matrix:
        include:
          # Apple Silicon (ARM64) - M1/M2/M3 èŠ¯ç‰‡
          - runner: macos-latest
            arch: arm64
            arch_name: "Apple Silicon"

          # Intel (x86_64) - æ—§æ¬¾ Mac
          - runner: macos-13
            arch: x86_64
            arch_name: "Intel"

    runs-on: ${{ matrix.runner }}

    name: Build for ${{ matrix.arch_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display build info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”¨ Build Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Runner: ${{ matrix.runner }}"
          echo "Target Architecture: ${{ matrix.arch_name }} (${{ matrix.arch }})"
          echo "System Architecture: $(uname -m)"
          echo "macOS Version: $(sw_vers -productVersion)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Verify icon file
        run: |
          if [ -f "favicon.icns" ]; then
            echo "âœ… Icon file found"
            ls -lh favicon.icns
          else
            echo "âŒ favicon.icns not found!"
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify Python architecture
        run: |
          echo "Python Architecture:"
          python3 -c "import platform; print(f'  Machine: {platform.machine()}')"
          python3 -c "import platform; print(f'  Processor: {platform.processor()}')"
          python3 -c "import struct; print(f'  Bits: {struct.calcsize(\"P\") * 8}-bit')"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-${{ matrix.arch }}-pip-${{ hashFiles('requirements-macos.txt') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements-macos.txt

      - name: Build with PyInstaller
        run: |
          echo "ğŸ”¨ Starting build for ${{ matrix.arch_name }}..."
          pyinstaller app-macos.spec --clean --noconfirm

      - name: Verify build
        run: |
          if [ -d "dist/Arkham Card Maker.app" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Build Successful"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "App Size: $(du -sh 'dist/Arkham Card Maker.app' | cut -f1)"
            echo "Architecture: ${{ matrix.arch }}"
            echo ""
            # éªŒè¯äºŒè¿›åˆ¶æ¶æ„
            echo "Binary Architecture:"
            file "dist/Arkham Card Maker.app/Contents/MacOS/Arkham Card Maker"
            lipo -info "dist/Arkham Card Maker.app/Contents/MacOS/Arkham Card Maker" || true
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ Build failed"
            exit 1
          fi

      - name: Install create-dmg
        run: |
          brew install create-dmg

      - name: Filesystem Sync Before DMG
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ Syncing filesystem..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # å¤šæ¬¡ sync ç¡®ä¿ I/O ç¨³å®š
          sync && sleep 1 && sync

          # å¥åº·æ£€æŸ¥: æŠ½æ ·è¯»å– .app èµ„æºç¡®ä¿æ–‡ä»¶å®Œæ•´å¯ç”¨
          echo "Verifying .app integrity..."
          find "dist/Arkham Card Maker.app/Contents" -type f | head -10 | xargs -I {} cat {} > /dev/null

          # Intel runner ä¸“å±é¢å¤–ç­‰å¾… (x86_64 æ¶æ„çš„ I/O ç¼“å­˜çª—å£æ›´é•¿)
          if [ "${{ matrix.arch }}" = "x86_64" ]; then
            echo "Intel runner detected - adding extra stabilization time..."
            sleep 3
          fi

          echo "âœ… Filesystem sync completed"

      - name: Create DMG
        run: |
          DMG_NAME="Arkham-Card-Maker-${{ matrix.arch }}.dmg"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“€ Creating DMG: $DMG_NAME"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # ============================================
          # äº”å±‚é˜²å¾¡æ¸…ç†æœºåˆ¶ (æŒ‡æ•°é€€é¿é‡è¯•)
          # ============================================
          echo "ğŸ§¹ Phase 1: Disk Device Cleanup (Critical Fix for Resource Busy)"
          # æ£€æµ‹å¹¶ detach æ‰€æœ‰ Arkham ç›¸å…³çš„ç£ç›˜è®¾å¤‡ (åŒ…æ‹¬æœªæŒ‚è½½åˆ° /Volumes çš„)
          for i in {1..5}; do
            # A. ä» hdiutil info è·å–æ‰€æœ‰ Arkham ç›¸å…³çš„é•œåƒè·¯å¾„
            ARKHAM_IMAGES=$(hdiutil info | grep -i "arkham" | grep "image-path" | awk '{print $3}')

            if [ -n "$ARKHAM_IMAGES" ]; then
              echo "  ğŸ” Found Arkham disk images:"
              echo "$ARKHAM_IMAGES" | while read -r img; do
                echo "    - $img"
                # å°è¯• detach é•œåƒè·¯å¾„
                hdiutil detach "$img" -force 2>/dev/null || true
              done
            fi

            # B. Detach æ‰€æœ‰ Arkham ç›¸å…³çš„æŒ‚è½½ç‚¹
            for vol in /Volumes/Arkham\ Card\ Maker*; do
              [ -d "$vol" ] && {
                echo "  Detaching volume: $vol"
                hdiutil detach "$vol" -force 2>/dev/null || true
              }
            done

            # C. æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ®‹ç•™
            if ! hdiutil info | grep -iq "arkham"; then
              echo "  âœ… All Arkham disk images/volumes detached"
              break
            fi

            # D. æŒ‡æ•°é€€é¿ç­‰å¾…
            WAIT_TIME=$((i * 2))
            echo "  â³ Retry $i: Waiting ${WAIT_TIME}s for device release..."
            sleep $WAIT_TIME
          done

          echo ""
          echo "ğŸ—‘ï¸  Phase 2: Ghost Mount Point Cleanup"
          # æ¸…ç†å¹½çµæŒ‚è½½ç‚¹ (å·²å¸è½½ä½†ç›®å½•æ®‹ç•™)
          for vol in /Volumes/Arkham\ Card\ Maker*; do
            [ -d "$vol" ] && {
              echo "  Removing ghost mount point: $vol"
              rmdir "$vol" 2>/dev/null || true
            }
          done

          echo ""
          echo "ğŸ§¼ Phase 3: Temporary DMG File Cleanup"
          # åˆ é™¤ create-dmg çš„ä¸´æ—¶ rw.*.dmg æ–‡ä»¶
          echo "  Searching for temporary rw.*.dmg files..."
          find . -maxdepth 1 -name "rw.*.dmg" -type f 2>/dev/null | while read -r tmpfile; do
            echo "  Removing temporary file: $tmpfile"
            rm -f "$tmpfile" 2>/dev/null || true
          done

          # åˆ é™¤æ—§çš„æœ€ç»ˆ DMG æ–‡ä»¶
          rm -f "$DMG_NAME" 2>/dev/null || true

          echo "  âœ… File cleanup completed"

          echo ""
          echo "ğŸ“Š Phase 4: Pre-Creation Diagnostics"
          echo "  Verifying cleanup status..."
          hdiutil info | grep -i "arkham" || echo "  âœ… No Arkham volumes in hdiutil info"
          lsof +D /Volumes 2>/dev/null | grep -i "arkham" || echo "  âœ… No Arkham processes holding /Volumes"
          echo ""

          # ============================================
          # DMG åˆ›å»º (å¸¦é‡è¯•ä¸éš”ç¦»æœºåˆ¶)
          # ============================================
          MAX_RETRIES=2
          UNIQUE_VOLNAME="Arkham Card Maker (${{ matrix.arch }}-$(date +%s))"

          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ Attempt $attempt/$MAX_RETRIES: Starting DMG creation..."
            echo "   Volume Name: $UNIQUE_VOLNAME"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            if create-dmg \
              --volname "$UNIQUE_VOLNAME" \
              --volicon "favicon.icns" \
              --window-pos 200 120 \
              --window-size 800 400 \
              --icon-size 100 \
              --icon "Arkham Card Maker.app" 200 190 \
              --hide-extension "Arkham Card Maker.app" \
              --app-drop-link 600 185 \
              --no-internet-enable \
              "$DMG_NAME" \
              "dist/Arkham Card Maker.app"; then

              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… DMG creation succeeded on attempt $attempt"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              break
            else
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âŒ Attempt $attempt failed"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

              if [ $attempt -lt $MAX_RETRIES ]; then
                echo ""
                echo "ğŸ” Deep Diagnostics (Failed Attempt $attempt)"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

                # å¯¼å‡ºè¯¦ç»†è¯Šæ–­ä¿¡æ¯
                echo "ğŸ“‹ hdiutil info (verbose):"
                hdiutil info -verbose | grep -A 10 -i "arkham" || echo "  (No Arkham volumes)"
                echo ""

                echo "ğŸ’¾ diskutil list:"
                diskutil list | grep -A 5 -i "arkham" || echo "  (No Arkham disks)"
                echo ""

                echo "ğŸ“‚ Current mounts:"
                mount | grep -i "arkham" || echo "  (No Arkham mounts)"
                echo ""

                echo "ğŸ”’ Processes holding /Volumes:"
                lsof +D /Volumes 2>/dev/null | grep -i "arkham" || echo "  (No Arkham processes)"
                echo ""

                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ğŸ”„ Deep cleanup before retry..."
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

                # æ·±åº¦æ¸…ç† (å¤ç”¨äº”å±‚é˜²å¾¡é€»è¾‘)
                # 1. Disk Device Cleanup
                for i in {1..3}; do
                  ARKHAM_IMAGES=$(hdiutil info | grep -i "arkham" | grep "image-path" | awk '{print $3}')
                  if [ -n "$ARKHAM_IMAGES" ]; then
                    echo "$ARKHAM_IMAGES" | while read -r img; do
                      hdiutil detach "$img" -force 2>/dev/null || true
                    done
                  fi

                  for vol in /Volumes/Arkham\ Card\ Maker*; do
                    [ -d "$vol" ] && hdiutil detach "$vol" -force 2>/dev/null || true
                  done

                  hdiutil info | grep -iq "arkham" || break
                  sleep $((i * 3))
                done

                # 2. Ghost Mount Point Cleanup
                for vol in /Volumes/Arkham\ Card\ Maker*; do
                  [ -d "$vol" ] && rmdir "$vol" 2>/dev/null || true
                done

                # 3. Temporary DMG File Cleanup
                find . -maxdepth 1 -name "rw.*.dmg" -type f 2>/dev/null | while read -r tmpfile; do
                  rm -f "$tmpfile" 2>/dev/null || true
                done
                rm -f "$DMG_NAME" 2>/dev/null || true

                echo "â³ Waiting 10s before retry..."
                sleep 10
              else
                echo ""
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ğŸ’¥ All retry attempts exhausted"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                exit 1
              fi
            fi
          done

      - name: Verify DMG
        run: |
          DMG_FILE="Arkham-Card-Maker-${{ matrix.arch }}.dmg"
          if [ -f "$DMG_FILE" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ DMG Information"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "File: $DMG_FILE"
            echo "Size: $(du -sh '$DMG_FILE' | cut -f1)"
            echo "Architecture: ${{ matrix.arch }}"
            echo "For: ${{ matrix.arch_name }}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ DMG not found!"
            exit 1
          fi

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: Arkham-Card-Maker-${{ matrix.arch }}
          path: Arkham-Card-Maker-${{ matrix.arch }}.dmg
          retention-days: 30
          if-no-files-found: error

  build-windows:
    runs-on: windows-latest

    name: Build for Windows (x86_64)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          pyinstaller app.spec --clean --noconfirm

      - name: Prepare Windows directory
        shell: pwsh
        run: |
          if (Test-Path "dist/Arkham Card Maker") {
            Remove-Item "dist/Arkham Card Maker" -Recurse -Force
          }
          if (-Not (Test-Path "dist/ArkhamHomebrew")) {
            Write-Error "dist/ArkhamHomebrew not found after build"
          }
          Rename-Item "dist/ArkhamHomebrew" "Arkham Card Maker"

      - name: Create Windows ZIP package
        shell: pwsh
        run: |
          Compress-Archive -Path "dist/Arkham Card Maker\*" -DestinationPath "Arkham-Card-Maker-win.zip" -Force

      - name: Upload Windows ZIP
        uses: actions/upload-artifact@v4
        with:
          name: Arkham-Card-Maker-win
          path: Arkham-Card-Maker-win.zip
          retention-days: 30
          if-no-files-found: error

  build-linux:
    strategy:
      matrix:
        include:
          # Debian ç³»åˆ— - ç”Ÿæˆ .deb åŒ…ï¼ˆé€‚ç”¨äº Ubuntuã€Mintã€Debian åŠå…¶è¡ç”Ÿç‰ˆï¼‰
          - distro: debian
            runner: ubuntu-22.04
            distro_name: "Debian/Ubuntu/Mint"
            distro_version: "Debian 11+, Ubuntu 22.04+, Mint 21+"
            pkg_format: deb
            pkg_manager: apt
            dependencies: "libgtk-3-0, libwebkit2gtk-4.0-37, libayatana-appindicator3-1, gir1.2-gtk-3.0, gir1.2-webkit2-4.0, python3-gi, python3-gi-cairo"
            install_cmd: |
              sudo apt-get update
              sudo apt-get install -y \
                python3 python3-pip python3-dev \
                libgtk-3-0 libwebkit2gtk-4.0-37 \
                libayatana-appindicator3-1 gir1.2-ayatanaappindicator3-0.1 \
                python3-gi python3-gi-cairo gir1.2-gtk-3.0 gir1.2-webkit2-4.0 \
                libgirepository1.0-dev libcairo2-dev pkg-config \
                binutils patchelf ruby ruby-dev build-essential
              sudo gem install --no-document fpm

          # Fedora ç³»åˆ— - ç”Ÿæˆ .rpm åŒ…ï¼ˆé€‚ç”¨äº Fedoraã€RHELã€CentOSï¼‰
          - distro: fedora
            runner: ubuntu-22.04
            distro_name: "Fedora/RHEL/CentOS"
            distro_version: "Fedora 38+, RHEL 9+, CentOS Stream 9+"
            pkg_format: rpm
            pkg_manager: dnf
            dependencies: "gtk3, webkit2gtk4.1, gobject-introspection, python3-gobject, python3-cairo"
            install_cmd: |
              # è®¾ç½® UTF-8 locale ä»¥æ”¯æŒä¸­æ–‡å­—ç¬¦
              dnf install -y glibc-langpack-en
              export LANG=en_US.UTF-8
              export LC_ALL=en_US.UTF-8

              dnf install -y \
                python3 python3-pip python3-devel \
                gtk3 webkit2gtk4.1 \
                python3-gobject python3-cairo gobject-introspection-devel cairo-devel \
                binutils patchelf \
                gcc gcc-c++ make \
                ruby ruby-devel rubygems rpm-build
              gem install --no-document fpm

          # é€šç”¨ Linux - ç”Ÿæˆ tar.gzï¼ˆé€‚ç”¨äºæ‰€æœ‰å…¶ä»–å‘è¡Œç‰ˆï¼‰
          - distro: generic
            runner: ubuntu-22.04
            distro_name: "Generic Linux"
            distro_version: "All distributions (Arch, openSUSE, Gentoo, etc.)"
            pkg_format: tar.gz
            pkg_manager: manual
            dependencies: ""
            install_cmd: |
              sudo apt-get update
              sudo apt-get install -y \
                python3 python3-pip python3-dev \
                libgtk-3-0 libwebkit2gtk-4.0-37 \
                libayatana-appindicator3-1 gir1.2-ayatanaappindicator3-0.1 \
                python3-gi python3-gi-cairo gir1.2-gtk-3.0 gir1.2-webkit2-4.0 \
                libgirepository1.0-dev libcairo2-dev pkg-config \
                binutils patchelf

    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.distro == 'fedora' && 'fedora:latest' || null }}

    name: Build for ${{ matrix.distro_name }} (${{ matrix.distro_version }})

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display build info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”¨ Build Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Distribution: ${{ matrix.distro_name }}"
          echo "Version: ${{ matrix.distro_version }}"
          echo "Package Format: ${{ matrix.pkg_format }}"
          echo "Package Manager: ${{ matrix.pkg_manager }}"
          echo "Runner: ${{ matrix.runner }}"
          echo "System Architecture: $(uname -m)"
          echo "Kernel Version: $(uname -r)"
          if command -v lsb_release &> /dev/null; then
            echo "OS Info: $(lsb_release -d | cut -f2-)"
          elif [ -f /etc/os-release ]; then
            echo "OS Info: $(grep PRETTY_NAME /etc/os-release | cut -d'"' -f2)"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Install system dependencies
        run: |
          echo "Installing dependencies for ${{ matrix.distro_name }}..."
          ${{ matrix.install_cmd }}

      # æ–¹æ¡ˆ1ï¼šä½¿ç”¨ç³»ç»Ÿ Python 3.10ï¼ˆä¸ä½¿ç”¨ actions/setup-pythonï¼‰
      - name: Configure Python environment
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”§ Configuring Python environment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # æ¸…é™¤é¢„è®¾çš„ PYTHONPATH é¿å…ç‰ˆæœ¬å†²çª
          echo "PYTHONPATH=" >> $GITHUB_ENV
          echo "PYTHONNOUSERSITE=1" >> $GITHUB_ENV

          # éªŒè¯ç³»ç»Ÿ Python ç‰ˆæœ¬å’Œ gi æ¨¡å—
          echo "Python version:"
          python3 --version
          echo ""
          echo "Python executable:"
          command -v python3
          echo ""

          # æ£€æŸ¥ gi æ¨¡å—æ˜¯å¦å¯ç”¨
          if python3 -c "import gi" 2>/dev/null; then
            echo "âœ… gi module available in system Python"
            python3 -c "import gi; print('   gi module path:', gi.__file__)"
          else
            echo "âš ï¸  Warning: gi module not found in system Python"
            echo "   This may cause build failures"
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Cache pip packages and venv
        if: matrix.distro != 'fedora'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            venv
          key: ${{ runner.os }}-${{ matrix.distro }}-venv-${{ hashFiles('requirements-linux.txt') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.distro }}-venv-

      - name: Install Python dependencies
        run: |
          # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆå¦‚æœä¸å­˜åœ¨ï¼Œ--system-site-packages å…è®¸è®¿é—®ç³»ç»Ÿ gi æ¨¡å—ï¼‰
          if [ ! -d "venv" ]; then
            echo "Creating new virtual environment..."
            python3 -m venv --system-site-packages venv
          else
            echo "Virtual environment restored from cache"
          fi

          source venv/bin/activate

          # åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…ä¾èµ–
          pip install --upgrade pip setuptools wheel
          pip install pyinstaller
          pip install -r requirements-linux.txt

          # å°†è™šæ‹Ÿç¯å¢ƒçš„ bin ç›®å½•æ·»åŠ åˆ° PATHï¼ˆåç»­æ­¥éª¤ç”Ÿæ•ˆï¼‰
          echo "${{ github.workspace }}/venv/bin" >> $GITHUB_PATH

          # ä¿å­˜è™šæ‹Ÿç¯å¢ƒæ¿€æ´»çŠ¶æ€ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡ï¼‰
          echo "VIRTUAL_ENV=${{ github.workspace }}/venv" >> $GITHUB_ENV

      - name: Verify GTK and PyGObject installation
        run: |
          # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
          source venv/bin/activate

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Verifying GTK and PyGObject installation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          python3 - << 'PY'
          import sys
          import gi

          print("âœ“ Python:", sys.version)
          print("âœ“ Python executable:", sys.executable)
          print("âœ“ gi module path:", gi.__file__)
          print()

          # éªŒè¯ GTK/WebKit2/Cairo
          gi.require_version("Gtk", "3.0")
          from gi.repository import Gtk, WebKit2, GLib, GObject
          import cairo

          print("âœ“ GTK 3.0: OK")
          print("âœ“ WebKit2: OK")
          print("âœ“ cairo: OK")
          print()
          print("âœ… All modules verified successfully")
          PY

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Build with PyInstaller
        run: |
          echo "ğŸ”¨ Starting build for ${{ matrix.distro_name }}..."

          # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼ˆç¡®ä¿æ‰€æœ‰å‘è¡Œç‰ˆéƒ½èƒ½æ‰¾åˆ° pyinstallerï¼‰
          source venv/bin/activate

          pyinstaller app-linux.spec --clean --noconfirm

      - name: Verify build
        run: |
          if [ -d "dist/Arkham Card Maker" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Build Successful"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Distribution: ${{ matrix.distro_name }}"
            echo "App Size: $(du -sh 'dist/Arkham Card Maker' | cut -f1)"
            echo "Architecture: x86_64"
            echo ""
            echo "Binary Information:"
            file "dist/Arkham Card Maker/Arkham Card Maker"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ Build failed"
            exit 1
          fi

      # åŸç”ŸåŒ…æ„å»ºï¼ˆ.deb æˆ– .rpmï¼‰
      - name: Prepare package structure (native packages)
        if: matrix.pkg_format != 'tar.gz'
        run: |
          mkdir -p package/opt/arkham-card-maker
          mkdir -p package/usr/share/applications
          mkdir -p package/usr/share/pixmaps

          # å¤åˆ¶åº”ç”¨æ–‡ä»¶
          cp -r "dist/Arkham Card Maker"/* package/opt/arkham-card-maker/

          # å¤åˆ¶å›¾æ ‡
          cp favicon.png package/usr/share/pixmaps/arkham-card-maker.png
          cp favicon.png package/opt/arkham-card-maker/favicon.png

          # å¤åˆ¶ .desktop æ–‡ä»¶å¹¶è®¾ç½®æƒé™
          cp arkham-card-maker.desktop package/usr/share/applications/
          chmod 644 package/usr/share/applications/arkham-card-maker.desktop

          # å‡†å¤‡ post-install è„šæœ¬
          mkdir -p scripts
          cp .github/scripts/postinstall.sh scripts/
          chmod 755 scripts/postinstall.sh

          echo "âœ… Package structure prepared"

      - name: Create native package (${{ matrix.pkg_format }})
        if: matrix.pkg_format != 'tar.gz'
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="1.0.0"
          fi

          echo "Creating ${{ matrix.pkg_format }} package version $VERSION..."

          # ä¸º Fedora container è®¾ç½® UTF-8 ç¯å¢ƒå˜é‡ï¼ˆè§£å†³ä¸­æ–‡ç¼–ç é—®é¢˜ï¼‰
          if [ "${{ matrix.distro }}" = "fedora" ]; then
            export LANG=en_US.UTF-8
            export LC_ALL=en_US.UTF-8
            echo "Set UTF-8 locale for RPM package creation"
          fi

          # å°†é€—å·åˆ†éš”çš„ä¾èµ–è½¬æ¢ä¸º fpm çš„ --depends å‚æ•°
          DEPS="${{ matrix.dependencies }}"
          DEPS_ARGS=""
          IFS=',' read -ra DEP_ARRAY <<< "$DEPS"
          for dep in "${DEP_ARRAY[@]}"; do
            dep=$(echo "$dep" | xargs)  # å»é™¤ç©ºæ ¼
            DEPS_ARGS="$DEPS_ARGS --depends $dep"
          done

          fpm -s dir -t ${{ matrix.pkg_format }} \
            -n arkham-card-maker \
            -v "$VERSION" \
            --vendor "Arkham Card Maker Team" \
            --maintainer "Arkham Card Maker <support@arkham-card-maker.com>" \
            --description "Create custom cards for Arkham Horror LCG" \
            --url "https://github.com/xziying44/arkham-homebrew" \
            --license "MIT" \
            --architecture x86_64 \
            $DEPS_ARGS \
            --after-install scripts/postinstall.sh \
            --after-remove /dev/null \
            -C package \
            opt usr

          echo "âœ… ${{ matrix.pkg_format }} package created successfully"

      - name: Verify native package
        if: matrix.pkg_format != 'tar.gz'
        run: |
          PACKAGE_FILE=$(ls arkham-card-maker*.${{ matrix.pkg_format }})
          if [ -f "$PACKAGE_FILE" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ ${{ matrix.distro_name }} Package Information"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "File: $PACKAGE_FILE"
            echo "Size: $(du -sh '$PACKAGE_FILE' | cut -f1)"
            echo "Format: ${{ matrix.pkg_format }}"
            echo "Distribution: ${{ matrix.distro_name }}"
            echo "Architecture: x86_64"
            echo ""
            echo "Package Contents:"
            if [ "${{ matrix.pkg_format }}" = "deb" ]; then
              dpkg -c "$PACKAGE_FILE" | head -20
            else
              rpm -qlp "$PACKAGE_FILE" | head -20
            fi
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ Package not found!"
            exit 1
          fi

      - name: Rename native package
        if: matrix.pkg_format != 'tar.gz'
        run: |
          PACKAGE_FILE=$(ls arkham-card-maker*.${{ matrix.pkg_format }})
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="1.0.0"
          fi
          NEW_NAME="arkham-card-maker_${VERSION}_${{ matrix.distro }}.${{ matrix.pkg_format }}"
          mv "$PACKAGE_FILE" "$NEW_NAME"
          echo "âœ… Renamed to: $NEW_NAME"

      # é€šç”¨ tar.gz æ„å»º
      - name: Create generic tar.gz package
        if: matrix.pkg_format == 'tar.gz'
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="1.0.0"
          fi

          cd dist
          tar -czf "../arkham-card-maker_${VERSION}_linux.tar.gz" "Arkham Card Maker"
          cd ..
          echo "âœ… Generic tar.gz created successfully"

      - name: Verify tar.gz package
        if: matrix.pkg_format == 'tar.gz'
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="1.0.0"
          fi
          PACKAGE_FILE="arkham-card-maker_${VERSION}_linux.tar.gz"
          if [ -f "$PACKAGE_FILE" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Generic Linux Package Information"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "File: $PACKAGE_FILE"
            echo "Size: $(du -sh '$PACKAGE_FILE' | cut -f1)"
            echo "Format: tar.gz"
            echo "Compatible: All Linux distributions"
            echo "Architecture: x86_64"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ tar.gz not found!"
            exit 1
          fi

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: arkham-card-maker-${{ matrix.distro }}
          path: |
            arkham-card-maker_*_${{ matrix.distro }}.${{ matrix.pkg_format }}
            arkham-card-maker_*_linux.tar.gz
          retention-days: 30
          if-no-files-found: error

  # åˆ›å»ºæ„å»ºæ‘˜è¦
  build-summary:
    needs:
      - build-macos
      - build-linux
    runs-on: ubuntu-latest

    steps:
      - name: Create Build Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ğŸ‰ æ„å»ºå®Œæˆ

          ## ğŸ“¥ ä¸‹è½½å®‰è£…åŒ…

          ### ğŸ macOS
          - **Apple Silicon (M1/M2/M3)**: `Arkham-Card-Maker-arm64.dmg`
          - **Intel**: `Arkham-Card-Maker-x86_64.dmg`

          **å®‰è£…ï¼š** åŒå‡» DMG â†’ æ‹–æ‹½åˆ° Applications â†’ å³é”®æ‰“å¼€ï¼ˆç»•è¿‡ç­¾åè­¦å‘Šï¼‰

          ---

          ### ğŸªŸ Windows (64ä½)
          - **ä¸‹è½½ï¼š** `Arkham-Card-Maker-win.zip`

          **å®‰è£…ï¼š** ä½¿ç”¨ **7-Zip/Bandizip/WinRAR** è§£å‹ â†’ è¿è¡Œ `Arkham Card Maker.exe`

          #### âš ï¸ ç‰¹åˆ«æé†’
          **ä¸æ¨èä½¿ç”¨ Windows è‡ªå¸¦ ZIP è§£å‹**ï¼Œå¯èƒ½å¯¼è‡´ DLL æ–‡ä»¶è¢«é”å®šè€Œæ— æ³•è¿è¡Œã€‚è¯·ä½¿ç”¨ç¬¬ä¸‰æ–¹è§£å‹è½¯ä»¶ã€‚

          #### **Important Note for Windows Users**
          **Do NOT use the default Windows ZIP extractor**. It may lock DLL files, preventing the app from running. Use 7-Zip, Bandizip, or WinRAR instead.

          ---

          ### ğŸ§ Linux
          - **Debian/Ubuntu/Mint**: `arkham-card-maker_xxx_debian.deb`
          - **Fedora/RHEL/CentOS**: `arkham-card-maker_xxx_fedora.rpm`
          - **å…¶ä»–å‘è¡Œç‰ˆ**: `arkham-card-maker_xxx_linux.tar.gz`

          **å®‰è£…ï¼ˆåŸç”ŸåŒ…ï¼‰ï¼š**
          ```bash
          # Debian/Ubuntu
          sudo dpkg -i arkham-card-maker_*_debian.deb && sudo apt-get install -f

          # Fedora/RHEL
          sudo dnf install arkham-card-maker_*_fedora.rpm
          ```

          **é€šç”¨ç‰ˆæœ¬ï¼š**
          ```bash
          tar -xzf arkham-card-maker_*_linux.tar.gz
          cd "Arkham Card Maker" && ./Arkham\ Card\ Maker
          ```

          ---

          **â“ å¦‚ä½•ç¡®å®š Mac èŠ¯ç‰‡ï¼Ÿ** å·¦ä¸Šè§’  â†’ å…³äºæœ¬æœº â†’ æŸ¥çœ‹"èŠ¯ç‰‡"ï¼ˆM1/M2/M3 = ARM64ï¼ŒIntel = x86_64ï¼‰

          *æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF

  release:
    needs:
      - build-macos
      - build-windows
      - build-linux
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    env:
      VERSION: ${{ github.ref_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts structure
        run: |
          echo "Downloaded artifacts:"
          ls -R artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release

          # macOS
          mv "artifacts/Arkham-Card-Maker-arm64/Arkham-Card-Maker-arm64.dmg" \
             "release/Arkham-Card-Maker-${VERSION}-macos-arm64.dmg"
          mv "artifacts/Arkham-Card-Maker-x86_64/Arkham-Card-Maker-x86_64.dmg" \
             "release/Arkham-Card-Maker-${VERSION}-macos-x86_64.dmg"

          # Windows
          mv "artifacts/Arkham-Card-Maker-win/Arkham-Card-Maker-win.zip" \
             "release/Arkham-Card-Maker-${VERSION}-win.zip"

          # Linux - Debian (.deb)
          DEBIAN_DEB=$(find artifacts/arkham-card-maker-debian -name "*.deb")
          cp "$DEBIAN_DEB" "release/arkham-card-maker-${VERSION}-debian.deb"

          # Linux - Fedora (.rpm)
          FEDORA_RPM=$(find artifacts/arkham-card-maker-fedora -name "*.rpm")
          cp "$FEDORA_RPM" "release/arkham-card-maker-${VERSION}-fedora.rpm"

          # Linux - Generic (tar.gz)
          GENERIC_TAR=$(find artifacts/arkham-card-maker-generic -name "*_linux.tar.gz")
          cp "$GENERIC_TAR" "release/arkham-card-maker-${VERSION}-linux.tar.gz"

          echo "Release assets prepared:"
          ls -lh release/

      - name: Extract changelog for current version
        id: changelog
        run: |
          VERSION="${{ github.ref_name }}"
          echo "Extracting changelog for version: $VERSION"

          # æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—ï¼ˆä» ## [vX.X.X] æˆ– ## [X.X.X] åˆ°ä¸‹ä¸€ä¸ª ## ä¹‹é—´çš„å†…å®¹ï¼‰
          # æ”¯æŒå¸¦ v å‰ç¼€å’Œä¸å¸¦ v å‰ç¼€çš„ç‰ˆæœ¬å·
          VERSION_NO_V="${VERSION#v}"

          # æå–ä¸­æ–‡æ›´æ–°æ—¥å¿—
          CHANGELOG_ZH=$(awk "/## \[v?${VERSION_NO_V}\]/,/^## \[/" CHANGELOG.md | sed '1d;$d' | sed '/^$/d')
          if [ -z "$CHANGELOG_ZH" ]; then
            echo "âš ï¸  No Chinese changelog found for version $VERSION, using default message"
            CHANGELOG_ZH="è¯·æŸ¥çœ‹å®Œæ•´æ›´æ–°æ—¥å¿—ï¼š[CHANGELOG.md](https://github.com/xziying44/arkham-homebrew/blob/main/CHANGELOG.md)"
          else
            echo "âœ… Chinese changelog extracted successfully"
          fi

          # æå–è‹±æ–‡æ›´æ–°æ—¥å¿—
          CHANGELOG_EN=$(awk "/## \[v?${VERSION_NO_V}\]/,/^## \[/" CHANGELOG_EN.md | sed '1d;$d' | sed '/^$/d')
          if [ -z "$CHANGELOG_EN" ]; then
            echo "âš ï¸  No English changelog found for version $VERSION, using default message"
            CHANGELOG_EN="See full changelog: [CHANGELOG_EN.md](https://github.com/xziying44/arkham-homebrew/blob/main/CHANGELOG_EN.md)"
          else
            echo "âœ… English changelog extracted successfully"
          fi

          # è¾“å‡ºåˆ° GitHub Actions ç¯å¢ƒå˜é‡ï¼ˆå¤„ç†å¤šè¡Œï¼‰
          {
            echo "CHANGELOG_ZH<<EOF"
            echo "$CHANGELOG_ZH"
            echo "EOF"
            echo "CHANGELOG_EN<<EOF"
            echo "$CHANGELOG_EN"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            release/Arkham-Card-Maker-${{ env.VERSION }}-macos-arm64.dmg
            release/Arkham-Card-Maker-${{ env.VERSION }}-macos-x86_64.dmg
            release/Arkham-Card-Maker-${{ env.VERSION }}-win.zip
            release/arkham-card-maker-${{ env.VERSION }}-debian.deb
            release/arkham-card-maker-${{ env.VERSION }}-fedora.rpm
            release/arkham-card-maker-${{ env.VERSION }}-linux.tar.gz
          body: |
            ## ğŸ‰ Arkham Card Maker ${{ env.VERSION }}

            ### âœ¨ æ›´æ–°æ—¥å¿— / What's New

            #### ä¸­æ–‡ / Chinese
            ${{ steps.changelog.outputs.CHANGELOG_ZH }}

            #### English
            ${{ steps.changelog.outputs.CHANGELOG_EN }}

            ---

            ### ğŸ“¦ ä¸‹è½½å®‰è£…åŒ…

            #### ğŸ macOS
            - **Apple Silicon (M1/M2/M3)**: `Arkham-Card-Maker-${{ env.VERSION }}-macos-arm64.dmg`
            - **Intel**: `Arkham-Card-Maker-${{ env.VERSION }}-macos-x86_64.dmg`

            **å®‰è£…ï¼š** åŒå‡» DMG â†’ æ‹–æ‹½åˆ° Applications â†’ å³é”®æ‰“å¼€

            ---

            #### ğŸªŸ Windows (64ä½)
            - **ä¸‹è½½ï¼š** `Arkham-Card-Maker-${{ env.VERSION }}-win.zip`

            **å®‰è£…ï¼š** ä½¿ç”¨ **7-Zip/Bandizip/WinRAR** è§£å‹ â†’ è¿è¡Œ exe

            #### âš ï¸ ç‰¹åˆ«æé†’
            **ä¸æ¨èä½¿ç”¨ Windows è‡ªå¸¦ ZIP è§£å‹**ï¼Œå¯èƒ½å¯¼è‡´ DLL æ–‡ä»¶è¢«é”å®šã€‚è¯·ä½¿ç”¨ç¬¬ä¸‰æ–¹è§£å‹è½¯ä»¶ã€‚

            #### **Important Note for Windows Users**
            **Do NOT use the default Windows ZIP extractor**. It may lock DLL files. Use 7-Zip, Bandizip, or WinRAR instead.

            ---

            #### ğŸ§ Linux
            - **Debian/Ubuntu/Mint**: `arkham-card-maker-${{ env.VERSION }}-debian.deb`
            - **Fedora/RHEL/CentOS**: `arkham-card-maker-${{ env.VERSION }}-fedora.rpm`
            - **å…¶ä»–å‘è¡Œç‰ˆ**: `arkham-card-maker-${{ env.VERSION }}-linux.tar.gz`

            **å®‰è£…ï¼š**
            ```bash
            # Debian/Ubuntu
            sudo dpkg -i arkham-card-maker-${{ env.VERSION }}-debian.deb && sudo apt-get install -f

            # Fedora/RHEL
            sudo dnf install arkham-card-maker-${{ env.VERSION }}-fedora.rpm

            # é€šç”¨ç‰ˆæœ¬
            tar -xzf arkham-card-maker-${{ env.VERSION }}-linux.tar.gz
            cd "Arkham Card Maker" && ./Arkham\ Card\ Maker
            ```

            ---

            *å®Œæ•´æ–‡æ¡£è¯·æŸ¥çœ‹ [README](https://github.com/xziying44/arkham-homebrew)*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
