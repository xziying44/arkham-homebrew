name: Build Desktop App (macOS + Windows)

on:
  workflow_dispatch:
  push:
    tags:
      - "*"

jobs:
  build-macos:
    strategy:
      matrix:
        include:
          # Apple Silicon (ARM64) - M1/M2/M3 èŠ¯ç‰‡
          - runner: macos-latest
            arch: arm64
            arch_name: "Apple Silicon"

          # Intel (x86_64) - æ—§æ¬¾ Mac
          - runner: macos-13
            arch: x86_64
            arch_name: "Intel"

    runs-on: ${{ matrix.runner }}

    name: Build for ${{ matrix.arch_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display build info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”¨ Build Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Runner: ${{ matrix.runner }}"
          echo "Target Architecture: ${{ matrix.arch_name }} (${{ matrix.arch }})"
          echo "System Architecture: $(uname -m)"
          echo "macOS Version: $(sw_vers -productVersion)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Verify icon file
        run: |
          if [ -f "favicon.icns" ]; then
            echo "âœ… Icon file found"
            ls -lh favicon.icns
          else
            echo "âŒ favicon.icns not found!"
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify Python architecture
        run: |
          echo "Python Architecture:"
          python3 -c "import platform; print(f'  Machine: {platform.machine()}')"
          python3 -c "import platform; print(f'  Processor: {platform.processor()}')"
          python3 -c "import struct; print(f'  Bits: {struct.calcsize(\"P\") * 8}-bit')"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-${{ matrix.arch }}-pip-${{ hashFiles('requirements-macos.txt') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements-macos.txt

      - name: Build with PyInstaller
        run: |
          echo "ğŸ”¨ Starting build for ${{ matrix.arch_name }}..."
          pyinstaller app-macos.spec --clean --noconfirm

      - name: Verify build
        run: |
          if [ -d "dist/Arkham Card Maker.app" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Build Successful"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "App Size: $(du -sh 'dist/Arkham Card Maker.app' | cut -f1)"
            echo "Architecture: ${{ matrix.arch }}"
            echo ""
            # éªŒè¯äºŒè¿›åˆ¶æ¶æ„
            echo "Binary Architecture:"
            file "dist/Arkham Card Maker.app/Contents/MacOS/Arkham Card Maker"
            lipo -info "dist/Arkham Card Maker.app/Contents/MacOS/Arkham Card Maker" || true
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ Build failed"
            exit 1
          fi

      - name: Install dmgbuild
        run: |
          pip install dmgbuild

      - name: Create DMG
        run: |
          DMG_NAME="Arkham-Card-Maker-${{ matrix.arch }}.dmg"
          VOLUME_NAME="Arkham Card Maker (${{ matrix.arch_name }})"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“€ Creating DMG: $DMG_NAME"
          echo "   Architecture: ${{ matrix.arch }}"
          echo "   Volume Name: $VOLUME_NAME"
          echo "   Method: dmgbuild (Python)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # åˆ é™¤æ—§çš„ DMG æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          rm -f "$DMG_NAME" 2>/dev/null || true

          # ä½¿ç”¨å¤–éƒ¨ Python è„šæœ¬åˆ›å»º DMG
          python3 .github/scripts/create_dmg.py \
            --output "$DMG_NAME" \
            --volume-name "$VOLUME_NAME"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DMG creation completed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Verify DMG
        run: |
          DMG_FILE="Arkham-Card-Maker-${{ matrix.arch }}.dmg"
          if [ -f "$DMG_FILE" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ DMG Information"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "File: $DMG_FILE"
            echo "Size: $(du -sh '$DMG_FILE' | cut -f1)"
            echo "Architecture: ${{ matrix.arch }}"
            echo "For: ${{ matrix.arch_name }}"
            echo "Build Method: dmgbuild (Python)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ DMG not found!"
            exit 1
          fi

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: Arkham-Card-Maker-${{ matrix.arch }}
          path: Arkham-Card-Maker-${{ matrix.arch }}.dmg
          retention-days: 30
          if-no-files-found: error

  build-windows:
    runs-on: windows-latest

    name: Build for Windows (x86_64)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          pyinstaller app.spec --clean --noconfirm

      - name: Prepare Windows directory
        shell: pwsh
        run: |
          if (Test-Path "dist/Arkham Card Maker") {
            Remove-Item "dist/Arkham Card Maker" -Recurse -Force
          }
          if (-Not (Test-Path "dist/ArkhamHomebrew")) {
            Write-Error "dist/ArkhamHomebrew not found after build"
          }
          Rename-Item "dist/ArkhamHomebrew" "Arkham Card Maker"

      - name: Create Windows ZIP package
        shell: pwsh
        run: |
          Compress-Archive -Path "dist/Arkham Card Maker\*" -DestinationPath "Arkham-Card-Maker-win.zip" -Force

      - name: Upload Windows ZIP
        uses: actions/upload-artifact@v4
        with:
          name: Arkham-Card-Maker-win
          path: Arkham-Card-Maker-win.zip
          retention-days: 30
          if-no-files-found: error

  build-linux:
    strategy:
      matrix:
        include:
          # Debian ç³»åˆ— - ç”Ÿæˆ .deb åŒ…ï¼ˆé€‚ç”¨äº Ubuntuã€Mintã€Debian åŠå…¶è¡ç”Ÿç‰ˆï¼‰
          - distro: debian
            runner: ubuntu-24.04
            distro_name: "Debian/Ubuntu/Mint"
            distro_version: "Debian 12+, Ubuntu 24.04+, Mint 22+"
            pkg_format: deb
            pkg_manager: apt
            dependencies: "python3-pyqt6, python3-pyqt6.qtwebengine, libayatana-appindicator3-1"
            install_cmd: |
              sudo apt-get update
              sudo apt-get install -y \
                python3 python3-pip python3-dev \
                python3-pyqt6 python3-pyqt6.qtwebengine \
                libayatana-appindicator3-1 gir1.2-ayatanaappindicator3-0.1 \
                pkg-config \
                binutils patchelf ruby ruby-dev build-essential
              sudo gem install --no-document fpm

          # Fedora ç³»åˆ— - ç”Ÿæˆ .rpm åŒ…ï¼ˆé€‚ç”¨äº Fedoraã€RHELã€CentOSï¼‰
          - distro: fedora
            runner: ubuntu-22.04
            distro_name: "Fedora/RHEL/CentOS"
            distro_version: "Fedora 38+, RHEL 9+, CentOS Stream 9+"
            pkg_format: rpm
            pkg_manager: dnf
            dependencies: "python3-qt6, python3-qt6-webengine"
            install_cmd: |
              # è®¾ç½® UTF-8 locale ä»¥æ”¯æŒä¸­æ–‡å­—ç¬¦
              dnf install -y glibc-langpack-en
              export LANG=en_US.UTF-8
              export LC_ALL=en_US.UTF-8

              dnf install -y \
                python3 python3-pip python3-devel \
                python3-qt6 python3-qt6-webengine \
                binutils patchelf \
                gcc gcc-c++ make \
                ruby ruby-devel rubygems rpm-build
              gem install --no-document fpm

          # é€šç”¨ Linux - Ubuntu 22.04 åŸºç¡€ï¼ˆé€‚ç”¨äºæ—§ç‰ˆå‘è¡Œç‰ˆï¼‰- ä½¿ç”¨ PyQt5
          - distro: generic-ubuntu22
            runner: ubuntu-22.04
            distro_name: "Generic Linux (Ubuntu 22.04 base)"
            distro_version: "Ubuntu 22.04 LTS, Debian 11, Mint 20-21, and compatible distributions"
            ubuntu_version: "22.04"
            pkg_format: tar.gz
            pkg_manager: manual
            dependencies: ""
            install_cmd: |
              sudo apt-get update
              sudo apt-get install -y \
                python3 python3-pip python3-dev \
                python3-pyqt5 python3-pyqt5.qtwebengine \
                libayatana-appindicator3-1 gir1.2-ayatanaappindicator3-0.1 \
                pkg-config \
                binutils patchelf

          # é€šç”¨ Linux - Ubuntu 24.04 åŸºç¡€ï¼ˆé€‚ç”¨äºæ–°ç‰ˆå‘è¡Œç‰ˆï¼‰- ä½¿ç”¨ PyQt6
          - distro: generic-ubuntu24
            runner: ubuntu-24.04
            distro_name: "Generic Linux (Ubuntu 24.04 base)"
            distro_version: "Ubuntu 24.04 LTS, Debian 12+, Mint 22+, and newer distributions"
            ubuntu_version: "24.04"
            pkg_format: tar.gz
            pkg_manager: manual
            dependencies: ""
            install_cmd: |
              sudo apt-get update
              sudo apt-get install -y \
                python3 python3-pip python3-dev \
                python3-pyqt6 python3-pyqt6.qtwebengine \
                libayatana-appindicator3-1 gir1.2-ayatanaappindicator3-0.1 \
                pkg-config \
                binutils patchelf

    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.distro == 'fedora' && 'fedora:latest' || null }}

    name: Build for ${{ matrix.distro_name }} (${{ matrix.distro_version }})

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display build info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”¨ Build Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Distribution: ${{ matrix.distro_name }}"
          echo "Version: ${{ matrix.distro_version }}"
          echo "Package Format: ${{ matrix.pkg_format }}"
          echo "Package Manager: ${{ matrix.pkg_manager }}"
          echo "Runner: ${{ matrix.runner }}"
          echo "System Architecture: $(uname -m)"
          echo "Kernel Version: $(uname -r)"
          if command -v lsb_release &> /dev/null; then
            echo "OS Info: $(lsb_release -d | cut -f2-)"
          elif [ -f /etc/os-release ]; then
            echo "OS Info: $(grep PRETTY_NAME /etc/os-release | cut -d'"' -f2)"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Install system dependencies
        run: |
          echo "Installing dependencies for ${{ matrix.distro_name }}..."
          ${{ matrix.install_cmd }}

      # æ–¹æ¡ˆ1ï¼šä½¿ç”¨ç³»ç»Ÿ Python 3.10ï¼ˆä¸ä½¿ç”¨ actions/setup-pythonï¼‰
      - name: Configure Python environment
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”§ Configuring Python environment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # æ¸…é™¤é¢„è®¾çš„ PYTHONPATH é¿å…ç‰ˆæœ¬å†²çª
          echo "PYTHONPATH=" >> $GITHUB_ENV
          echo "PYTHONNOUSERSITE=1" >> $GITHUB_ENV

          # éªŒè¯ç³»ç»Ÿ Python ç‰ˆæœ¬å’Œ gi æ¨¡å—
          echo "Python version:"
          python3 --version
          echo ""
          echo "Python executable:"
          command -v python3
          echo ""

          # æ£€æŸ¥ gi æ¨¡å—æ˜¯å¦å¯ç”¨
          if python3 -c "import gi" 2>/dev/null; then
            echo "âœ… gi module available in system Python"
            python3 -c "import gi; print('   gi module path:', gi.__file__)"
          else
            echo "âš ï¸  Warning: gi module not found in system Python"
            echo "   This may cause build failures"
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Cache pip packages and venv
        if: matrix.distro != 'fedora'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            venv
          key: ${{ runner.os }}-${{ matrix.distro }}-venv-${{ hashFiles('requirements-linux.txt') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.distro }}-venv-

      - name: Install Python dependencies
        run: |
          # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆå¦‚æœä¸å­˜åœ¨ï¼Œ--system-site-packages å…è®¸è®¿é—®ç³»ç»Ÿ gi æ¨¡å—ï¼‰
          if [ ! -d "venv" ]; then
            echo "Creating new virtual environment..."
            python3 -m venv --system-site-packages venv
          else
            echo "Virtual environment restored from cache"
          fi

          source venv/bin/activate

          # åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…ä¾èµ–
          pip install --upgrade pip setuptools wheel
          pip install pyinstaller
          pip install -r requirements-linux.txt

          # å°†è™šæ‹Ÿç¯å¢ƒçš„ bin ç›®å½•æ·»åŠ åˆ° PATHï¼ˆåç»­æ­¥éª¤ç”Ÿæ•ˆï¼‰
          echo "${{ github.workspace }}/venv/bin" >> $GITHUB_PATH

          # ä¿å­˜è™šæ‹Ÿç¯å¢ƒæ¿€æ´»çŠ¶æ€ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡ï¼‰
          echo "VIRTUAL_ENV=${{ github.workspace }}/venv" >> $GITHUB_ENV

      - name: Verify Qt and PyQt installation
        run: |
          # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
          source venv/bin/activate

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Verifying Qt and PyQt installation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          python3 - << 'PY'
          import sys
          import os

          print("âœ“ Python:", sys.version)
          print("âœ“ Python executable:", sys.executable)
          print()

          # æ ¹æ® Ubuntu ç‰ˆæœ¬éªŒè¯å¯¹åº”çš„ PyQt ç‰ˆæœ¬
          ubuntu_version = os.environ.get('MATRIX_UBUNTU_VERSION', '24.04')

          if ubuntu_version == '22.04':
              # Ubuntu 22.04 ä½¿ç”¨ PyQt5
              try:
                  from PyQt5 import QtCore, QtWidgets, QtWebEngineWidgets
                  print("âœ“ PyQt5: OK")
                  print("  QtCore version:", QtCore.PYQT_VERSION_STR)
                  print("  Qt version:", QtCore.QT_VERSION_STR)
                  print("âœ“ QtWebEngineWidgets: OK")
              except ImportError as e:
                  print("âœ— PyQt5 import failed:", e)
                  sys.exit(1)
          else:
              # Ubuntu 24.04+ å’Œå…¶ä»–å‘è¡Œç‰ˆä½¿ç”¨ PyQt6
              try:
                  from PyQt6 import QtCore, QtWidgets, QtWebEngineWidgets
                  print("âœ“ PyQt6: OK")
                  print("  QtCore version:", QtCore.PYQT_VERSION_STR)
                  print("  Qt version:", QtCore.QT_VERSION_STR)
                  print("âœ“ QtWebEngineWidgets: OK")
              except ImportError as e:
                  print("âœ— PyQt6 import failed:", e)
                  sys.exit(1)

          print()
          print("âœ… All modules verified successfully")
          PY

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        env:
          MATRIX_UBUNTU_VERSION: ${{ matrix.ubuntu_version }}

      - name: Build with PyInstaller
        run: |
          echo "ğŸ”¨ Starting build for ${{ matrix.distro_name }}..."

          # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼ˆç¡®ä¿æ‰€æœ‰å‘è¡Œç‰ˆéƒ½èƒ½æ‰¾åˆ° pyinstallerï¼‰
          source venv/bin/activate

          pyinstaller app-linux.spec --clean --noconfirm

      - name: Verify build
        run: |
          if [ -d "dist/Arkham Card Maker" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Build Successful"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Distribution: ${{ matrix.distro_name }}"
            echo "App Size: $(du -sh 'dist/Arkham Card Maker' | cut -f1)"
            echo "Architecture: x86_64"
            echo ""
            echo "Binary Information:"
            file "dist/Arkham Card Maker/Arkham Card Maker"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ Build failed"
            exit 1
          fi

      # åŸç”ŸåŒ…æ„å»ºï¼ˆ.deb æˆ– .rpmï¼‰
      - name: Prepare package structure (native packages)
        if: matrix.pkg_format != 'tar.gz'
        run: |
          mkdir -p package/opt/arkham-card-maker
          mkdir -p package/usr/share/applications
          mkdir -p package/usr/share/pixmaps

          # å¤åˆ¶åº”ç”¨æ–‡ä»¶
          cp -r "dist/Arkham Card Maker"/* package/opt/arkham-card-maker/

          # å¤åˆ¶å›¾æ ‡
          cp favicon.png package/usr/share/pixmaps/arkham-card-maker.png
          cp favicon.png package/opt/arkham-card-maker/favicon.png

          # å¤åˆ¶ .desktop æ–‡ä»¶å¹¶è®¾ç½®æƒé™
          cp arkham-card-maker.desktop package/usr/share/applications/
          chmod 644 package/usr/share/applications/arkham-card-maker.desktop

          # å‡†å¤‡ post-install è„šæœ¬
          mkdir -p scripts
          cp .github/scripts/postinstall.sh scripts/
          chmod 755 scripts/postinstall.sh

          echo "âœ… Package structure prepared"

      - name: Create native package (${{ matrix.pkg_format }})
        if: matrix.pkg_format != 'tar.gz'
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="1.0.0"
          fi

          echo "Creating ${{ matrix.pkg_format }} package version $VERSION..."

          # ä¸º Fedora container è®¾ç½® UTF-8 ç¯å¢ƒå˜é‡ï¼ˆè§£å†³ä¸­æ–‡ç¼–ç é—®é¢˜ï¼‰
          if [ "${{ matrix.distro }}" = "fedora" ]; then
            export LANG=en_US.UTF-8
            export LC_ALL=en_US.UTF-8
            echo "Set UTF-8 locale for RPM package creation"
          fi

          # å°†é€—å·åˆ†éš”çš„ä¾èµ–è½¬æ¢ä¸º fpm çš„ --depends å‚æ•°
          DEPS="${{ matrix.dependencies }}"
          DEPS_ARGS=""
          IFS=',' read -ra DEP_ARRAY <<< "$DEPS"
          for dep in "${DEP_ARRAY[@]}"; do
            dep=$(echo "$dep" | xargs)  # å»é™¤ç©ºæ ¼
            DEPS_ARGS="$DEPS_ARGS --depends $dep"
          done

          fpm -s dir -t ${{ matrix.pkg_format }} \
            -n arkham-card-maker \
            -v "$VERSION" \
            --vendor "Arkham Card Maker Team" \
            --maintainer "Arkham Card Maker <support@arkham-card-maker.com>" \
            --description "Create custom cards for Arkham Horror LCG" \
            --url "https://github.com/xziying44/arkham-homebrew" \
            --license "MIT" \
            --architecture x86_64 \
            $DEPS_ARGS \
            --after-install scripts/postinstall.sh \
            --after-remove /dev/null \
            -C package \
            opt usr

          echo "âœ… ${{ matrix.pkg_format }} package created successfully"

      - name: Verify native package
        if: matrix.pkg_format != 'tar.gz'
        run: |
          PACKAGE_FILE=$(ls arkham-card-maker*.${{ matrix.pkg_format }})
          if [ -f "$PACKAGE_FILE" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ ${{ matrix.distro_name }} Package Information"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "File: $PACKAGE_FILE"
            echo "Size: $(du -sh '$PACKAGE_FILE' | cut -f1)"
            echo "Format: ${{ matrix.pkg_format }}"
            echo "Distribution: ${{ matrix.distro_name }}"
            echo "Architecture: x86_64"
            echo ""
            echo "Package Contents:"
            if [ "${{ matrix.pkg_format }}" = "deb" ]; then
              dpkg -c "$PACKAGE_FILE" | head -20
            else
              rpm -qlp "$PACKAGE_FILE" | head -20
            fi
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ Package not found!"
            exit 1
          fi

      - name: Rename native package
        if: matrix.pkg_format != 'tar.gz'
        run: |
          PACKAGE_FILE=$(ls arkham-card-maker*.${{ matrix.pkg_format }})
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="1.0.0"
          fi
          NEW_NAME="arkham-card-maker_${VERSION}_${{ matrix.distro }}.${{ matrix.pkg_format }}"
          mv "$PACKAGE_FILE" "$NEW_NAME"
          echo "âœ… Renamed to: $NEW_NAME"

      # é€šç”¨ tar.gz æ„å»º
      - name: Create generic tar.gz package
        if: matrix.pkg_format == 'tar.gz'
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="1.0.0"
          fi

          cd dist
          tar -czf "../arkham-card-maker_${VERSION}_linux-ubuntu${{ matrix.ubuntu_version }}.tar.gz" "Arkham Card Maker"
          cd ..
          echo "âœ… Generic tar.gz (Ubuntu ${{ matrix.ubuntu_version }}) created successfully"

      - name: Verify tar.gz package
        if: matrix.pkg_format == 'tar.gz'
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="1.0.0"
          fi
          PACKAGE_FILE="arkham-card-maker_${VERSION}_linux-ubuntu${{ matrix.ubuntu_version }}.tar.gz"
          if [ -f "$PACKAGE_FILE" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Generic Linux Package Information"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "File: $PACKAGE_FILE"
            echo "Size: $(du -sh '$PACKAGE_FILE' | cut -f1)"
            echo "Format: tar.gz"
            echo "Base: Ubuntu ${{ matrix.ubuntu_version }} LTS"
            echo "Compatible: All Linux distributions"
            echo "Architecture: x86_64"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ tar.gz not found!"
            exit 1
          fi

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: arkham-card-maker-${{ matrix.distro }}
          path: |
            arkham-card-maker_*_${{ matrix.distro }}.${{ matrix.pkg_format }}
            arkham-card-maker_*_linux-ubuntu${{ matrix.ubuntu_version }}.tar.gz
          retention-days: 30
          if-no-files-found: error

  # åˆ›å»ºæ„å»ºæ‘˜è¦
  build-summary:
    needs:
      - build-macos
      - build-linux
    runs-on: ubuntu-latest

    steps:
      - name: Create Build Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ğŸ‰ æ„å»ºå®Œæˆ

          ## ğŸ“¥ ä¸‹è½½å®‰è£…åŒ…

          ### ğŸ macOS
          - **Apple Silicon (M1/M2/M3)**: `Arkham-Card-Maker-arm64.dmg`
          - **Intel**: `Arkham-Card-Maker-x86_64.dmg`

          **å®‰è£…ï¼š** åŒå‡» DMG â†’ æ‹–æ‹½åˆ° Applications â†’ å³é”®æ‰“å¼€ï¼ˆç»•è¿‡ç­¾åè­¦å‘Šï¼‰

          ---

          ### ğŸªŸ Windows (64ä½)
          - **ä¸‹è½½ï¼š** `Arkham-Card-Maker-win.zip`

          **å®‰è£…ï¼š** ä½¿ç”¨ **7-Zip/Bandizip/WinRAR** è§£å‹ â†’ è¿è¡Œ `Arkham Card Maker.exe`

          #### âš ï¸ ç‰¹åˆ«æé†’
          **ä¸æ¨èä½¿ç”¨ Windows è‡ªå¸¦ ZIP è§£å‹**ï¼Œå¯èƒ½å¯¼è‡´ DLL æ–‡ä»¶è¢«é”å®šè€Œæ— æ³•è¿è¡Œã€‚è¯·ä½¿ç”¨ç¬¬ä¸‰æ–¹è§£å‹è½¯ä»¶ã€‚

          #### **Important Note for Windows Users**
          **Do NOT use the default Windows ZIP extractor**. It may lock DLL files, preventing the app from running. Use 7-Zip, Bandizip, or WinRAR instead.

          ---

          ### ğŸ§ Linux
          - **Debian/Ubuntu 24.04+/Mint 22+**: `arkham-card-maker_xxx_debian.deb`
          - **Fedora/RHEL/CentOS**: `arkham-card-maker_xxx_fedora.rpm`
          - **é€šç”¨ç‰ˆæœ¬ï¼ˆUbuntu 22.04 baseï¼‰**: `arkham-card-maker_xxx_linux-ubuntu22.04.tar.gz`
          - **é€šç”¨ç‰ˆæœ¬ï¼ˆUbuntu 24.04 baseï¼‰**: `arkham-card-maker_xxx_linux-ubuntu24.04.tar.gz`

          **å®‰è£…ï¼ˆåŸç”ŸåŒ…ï¼‰ï¼š**
          ```bash
          # Debian/Ubuntu 24.04+
          sudo dpkg -i arkham-card-maker_*_debian.deb && sudo apt-get install -f

          # Fedora/RHEL
          sudo dnf install arkham-card-maker_*_fedora.rpm
          ```

          **é€šç”¨ç‰ˆæœ¬ï¼ˆé€‰æ‹©åŒ¹é…çš„åŸºç¡€ç‰ˆæœ¬ï¼‰ï¼š**
          ```bash
          # Ubuntu 22.04 / Debian 11 / Mint 20-21 / æ—§ç‰ˆç³»ç»Ÿ
          tar -xzf arkham-card-maker_*_linux-ubuntu22.04.tar.gz
          cd "Arkham Card Maker" && ./Arkham\ Card\ Maker

          # Ubuntu 24.04 / Debian 12+ / Mint 22+ / æ–°ç‰ˆç³»ç»Ÿ
          tar -xzf arkham-card-maker_*_linux-ubuntu24.04.tar.gz
          cd "Arkham Card Maker" && ./Arkham\ Card\ Maker
          ```

          **ğŸ’¡ é€‰æ‹©æŒ‡å—ï¼š**
          - **æœ‰ç–‘é—®ï¼Ÿ** é€‰æ‹© Ubuntu 22.04 ç‰ˆæœ¬ï¼ˆæ›´å¥½çš„å…¼å®¹æ€§ï¼‰
          - **æœ€æ–°ç³»ç»Ÿï¼Ÿ** é€‰æ‹© Ubuntu 24.04 ç‰ˆæœ¬ï¼ˆæ›´æ–°çš„åº“ï¼‰

          ---

          **â“ å¦‚ä½•ç¡®å®š Mac èŠ¯ç‰‡ï¼Ÿ** å·¦ä¸Šè§’  â†’ å…³äºæœ¬æœº â†’ æŸ¥çœ‹"èŠ¯ç‰‡"ï¼ˆM1/M2/M3 = ARM64ï¼ŒIntel = x86_64ï¼‰

          *æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF

  release:
    needs:
      - build-macos
      - build-windows
      - build-linux
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    env:
      VERSION: ${{ github.ref_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts structure
        run: |
          echo "Downloaded artifacts:"
          ls -R artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release

          # macOS
          mv "artifacts/Arkham-Card-Maker-arm64/Arkham-Card-Maker-arm64.dmg" \
             "release/Arkham-Card-Maker-${VERSION}-macos-arm64.dmg"
          mv "artifacts/Arkham-Card-Maker-x86_64/Arkham-Card-Maker-x86_64.dmg" \
             "release/Arkham-Card-Maker-${VERSION}-macos-x86_64.dmg"

          # Windows
          mv "artifacts/Arkham-Card-Maker-win/Arkham-Card-Maker-win.zip" \
             "release/Arkham-Card-Maker-${VERSION}-win.zip"

          # Linux - Debian (.deb)
          DEBIAN_DEB=$(find artifacts/arkham-card-maker-debian -name "*.deb")
          cp "$DEBIAN_DEB" "release/arkham-card-maker-${VERSION}-debian.deb"

          # Linux - Fedora (.rpm)
          FEDORA_RPM=$(find artifacts/arkham-card-maker-fedora -name "*.rpm")
          cp "$FEDORA_RPM" "release/arkham-card-maker-${VERSION}-fedora.rpm"

          # Linux - Generic Ubuntu 22.04 (tar.gz)
          GENERIC_22=$(find artifacts/arkham-card-maker-generic-ubuntu22 -name "*ubuntu22.04.tar.gz")
          cp "$GENERIC_22" "release/arkham-card-maker-${VERSION}-linux-ubuntu22.04.tar.gz"

          # Linux - Generic Ubuntu 24.04 (tar.gz)
          GENERIC_24=$(find artifacts/arkham-card-maker-generic-ubuntu24 -name "*ubuntu24.04.tar.gz")
          cp "$GENERIC_24" "release/arkham-card-maker-${VERSION}-linux-ubuntu24.04.tar.gz"

          echo "Release assets prepared:"
          ls -lh release/

      - name: Extract changelog for current version
        id: changelog
        run: |
          VERSION="${{ github.ref_name }}"
          echo "Extracting changelog for version: $VERSION"

          # ç§»é™¤ v å‰ç¼€ï¼ˆå¦‚æœæœ‰ï¼‰
          VERSION_NO_V="${VERSION#v}"

          echo "Looking for version: ${VERSION_NO_V}"
          echo "Checking if CHANGELOG files exist..."
          ls -la CHANGELOG*.md || true

          # æå–ä¸­æ–‡æ›´æ–°æ—¥å¿—
          # ä½¿ç”¨ sed ä» ## [ç‰ˆæœ¬å·] å¼€å§‹æå–åˆ°ä¸‹ä¸€ä¸ª ## [ æˆ– --- åˆ†éš”ç¬¦
          echo "Extracting Chinese changelog..."
          CHANGELOG_ZH=$(sed -n "/^## \[${VERSION_NO_V}\]/,/^## \[/p" CHANGELOG.md | sed '1d;$d')

          # å¦‚æœä¸ºç©ºï¼Œå¯èƒ½æ˜¯æœ€åä¸€ä¸ªç‰ˆæœ¬ï¼Œå°è¯•æå–åˆ° --- åˆ†éš”ç¬¦
          if [ -z "$CHANGELOG_ZH" ]; then
            CHANGELOG_ZH=$(sed -n "/^## \[${VERSION_NO_V}\]/,/^---/p" CHANGELOG.md | sed '1d;$d')
          fi

          if [ -z "$CHANGELOG_ZH" ]; then
            echo "âš ï¸  No Chinese changelog found for version $VERSION"
            CHANGELOG_ZH="è¯·æŸ¥çœ‹å®Œæ•´æ›´æ–°æ—¥å¿—ï¼š[CHANGELOG.md](https://github.com/xziying44/arkham-homebrew/blob/master/CHANGELOG.md)"
          else
            echo "âœ… Chinese changelog extracted successfully"
            echo "Preview: ${CHANGELOG_ZH:0:100}..."
          fi

          # æå–è‹±æ–‡æ›´æ–°æ—¥å¿—
          echo "Extracting English changelog..."
          CHANGELOG_EN=$(sed -n "/^## \[${VERSION_NO_V}\]/,/^## \[/p" CHANGELOG_EN.md | sed '1d;$d')

          # å¦‚æœä¸ºç©ºï¼Œå¯èƒ½æ˜¯æœ€åä¸€ä¸ªç‰ˆæœ¬ï¼Œå°è¯•æå–åˆ° --- åˆ†éš”ç¬¦
          if [ -z "$CHANGELOG_EN" ]; then
            CHANGELOG_EN=$(sed -n "/^## \[${VERSION_NO_V}\]/,/^---/p" CHANGELOG_EN.md | sed '1d;$d')
          fi

          if [ -z "$CHANGELOG_EN" ]; then
            echo "âš ï¸  No English changelog found for version $VERSION"
            CHANGELOG_EN="See full changelog: [CHANGELOG_EN.md](https://github.com/xziying44/arkham-homebrew/blob/master/CHANGELOG_EN.md)"
          else
            echo "âœ… English changelog extracted successfully"
            echo "Preview: ${CHANGELOG_EN:0:100}..."
          fi

          # è¾“å‡ºåˆ° GitHub Actions ç¯å¢ƒå˜é‡ï¼ˆå¤„ç†å¤šè¡Œï¼‰
          {
            echo "CHANGELOG_ZH<<EOF"
            echo "$CHANGELOG_ZH"
            echo "EOF"
            echo "CHANGELOG_EN<<EOF"
            echo "$CHANGELOG_EN"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            release/Arkham-Card-Maker-${{ env.VERSION }}-macos-arm64.dmg
            release/Arkham-Card-Maker-${{ env.VERSION }}-macos-x86_64.dmg
            release/Arkham-Card-Maker-${{ env.VERSION }}-win.zip
            release/arkham-card-maker-${{ env.VERSION }}-debian.deb
            release/arkham-card-maker-${{ env.VERSION }}-fedora.rpm
            release/arkham-card-maker-${{ env.VERSION }}-linux-ubuntu22.04.tar.gz
            release/arkham-card-maker-${{ env.VERSION }}-linux-ubuntu24.04.tar.gz
          body: |
            ## ğŸ‰ Arkham Card Maker ${{ env.VERSION }}

            ### âœ¨ æ›´æ–°æ—¥å¿— / What's New

            #### ä¸­æ–‡ / Chinese
            ${{ steps.changelog.outputs.CHANGELOG_ZH }}

            #### English
            ${{ steps.changelog.outputs.CHANGELOG_EN }}

            ---

            ### ğŸ“¦ ä¸‹è½½å®‰è£…åŒ…

            #### ğŸ macOS
            - **Apple Silicon (M1/M2/M3)**: `Arkham-Card-Maker-${{ env.VERSION }}-macos-arm64.dmg`
            - **Intel**: `Arkham-Card-Maker-${{ env.VERSION }}-macos-x86_64.dmg`

            **å®‰è£…ï¼š** åŒå‡» DMG â†’ æ‹–æ‹½åˆ° Applications â†’ å³é”®æ‰“å¼€

            ---

            #### ğŸªŸ Windows (64ä½)
            - **ä¸‹è½½ï¼š** `Arkham-Card-Maker-${{ env.VERSION }}-win.zip`

            **å®‰è£…ï¼š** ä½¿ç”¨ **7-Zip/Bandizip/WinRAR** è§£å‹ â†’ è¿è¡Œ exe

            #### âš ï¸ ç‰¹åˆ«æé†’
            **ä¸æ¨èä½¿ç”¨ Windows è‡ªå¸¦ ZIP è§£å‹**ï¼Œå¯èƒ½å¯¼è‡´ DLL æ–‡ä»¶è¢«é”å®šã€‚è¯·ä½¿ç”¨ç¬¬ä¸‰æ–¹è§£å‹è½¯ä»¶ã€‚

            #### **Important Note for Windows Users**
            **Do NOT use the default Windows ZIP extractor**. It may lock DLL files. Use 7-Zip, Bandizip, or WinRAR instead.

            ---

            #### ğŸ§ Linux
            - **Debian/Ubuntu/Mint**: `arkham-card-maker-${{ env.VERSION }}-debian.deb` (Ubuntu 24.04+ base)
            - **Fedora/RHEL/CentOS**: `arkham-card-maker-${{ env.VERSION }}-fedora.rpm`
            - **å…¶ä»–å‘è¡Œç‰ˆ**:
              - **Ubuntu 22.04 LTS**: `arkham-card-maker-${{ env.VERSION }}-linux-ubuntu22.04.tar.gz`
              - **Ubuntu 24.04 LTS**: `arkham-card-maker-${{ env.VERSION }}-linux-ubuntu24.04.tar.gz`

            **å®‰è£…ï¼ˆåŸç”ŸåŒ…ï¼‰ï¼š**
            ```bash
            # Debian/Ubuntu 24.04+
            sudo dpkg -i arkham-card-maker-${{ env.VERSION }}-debian.deb && sudo apt-get install -f

            # Fedora/RHEL
            sudo dnf install arkham-card-maker-${{ env.VERSION }}-fedora.rpm
            ```

            **é€šç”¨ç‰ˆæœ¬ï¼ˆé€‰æ‹©åŒ¹é…çš„ Ubuntu ç‰ˆæœ¬ï¼‰ï¼š**
            ```bash
            # Ubuntu 22.04 / Debian 11 / Mint 20-21
            tar -xzf arkham-card-maker-${{ env.VERSION }}-linux-ubuntu22.04.tar.gz
            cd "Arkham Card Maker" && ./Arkham\ Card\ Maker

            # Ubuntu 24.04 / Debian 12+ / Mint 22+
            tar -xzf arkham-card-maker-${{ env.VERSION }}-linux-ubuntu24.04.tar.gz
            cd "Arkham Card Maker" && ./Arkham\ Card\ Maker
            ```

            ---

            *å®Œæ•´æ–‡æ¡£è¯·æŸ¥çœ‹ [README](https://github.com/xziying44/arkham-homebrew)*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
