# OpenAI卡牌生成相关接口

## 18. 流式生成卡牌JSON信息

### 基本信息

- **接口名称**: 流式生成卡牌JSON信息
- **请求地址**: `/api/generate-card-info`
- **请求方法**: `POST`
- **功能描述**: 使用OpenAI API根据用户输入的卡牌描述内容，基于提示词文件`player_card_picture.txt`流式生成卡牌JSON信息

### 请求参数

| 参数名  | 类型   | 必填 | 说明             |
| ------- | ------ | ---- | ---------------- |
| content | string | 是   | 卡牌描述文本内容 |

### 响应格式

本接口返回**Server-Sent Events (SSE)**流式数据，`Content-Type: text/plain`

流式数据格式：
```
data: {"content": "生成的文本片段"}\n\n
data: {"content": "下一个文本片段"}\n\n
...
data: {"done": true}\n\n
```

错误时返回：
```
data: {"error": "错误信息"}\n\n
```

### 请求示例

```bash
curl -X POST /api/generate-card-info \
  -H "Content-Type: application/json" \
  -d '{
    "content": "创建一个守护者调查员，名叫约翰·史密斯，四维是3223，生命值8，恐惧值5，背景是退役警察"
  }'
```

### 示例响应

```
data: {"content": "{\n  \"type\": \"调查员卡\",\n"}\n\n
data: {"content": "  \"class\": \"守护者\",\n"}\n\n
data: {"content": "  \"name\": \"约翰·史密斯\",\n"}\n\n
data: {"content": "  \"attribute\": [3, 2, 2, 3],\n"}\n\n
data: {"content": "  \"health\": 8,\n"}\n\n
data: {"content": "  \"horror\": 5,\n"}\n\n
data: {"content": "  \"body\": \"退役警察约翰拥有丰富的执法经验...\"\n"}\n\n
data: {"content": "}\n"}\n\n
data: {"done": true}\n\n
```

## 19. 解析验证卡牌JSON

### 基本信息

- **接口名称**: 解析验证卡牌JSON
- **请求地址**: `/api/parse-card-json`
- **请求方法**: `POST`
- **功能描述**: 解析AI返回的JSON文本，支持从Markdown代码块中提取JSON，并进行格式修复和字段验证

### 请求参数

| 参数名    | 类型   | 必填 | 说明                           |
| --------- | ------ | ---- | ------------------------------ |
| json_text | string | 是   | 需要解析的JSON文本或代码块内容 |

### 响应格式

| 字段           | 类型   | 说明           |
| -------------- | ------ | -------------- |
| data.card_json | object | 解析后的卡牌数据 |

### 请求示例

```bash
curl -X POST /api/parse-card-json \
  -H "Content-Type: application/json" \
  -d '{
    "json_text": "```json\n{\n  \"type\": \"调查员卡\",\n  \"name\": \"约翰·史密斯\",\n  \"body\": \"退役警察...\"\n}\n```"
  }'
```

### 示例响应

```json
{
  "code": 0,
  "msg": "JSON解析成功",
  "data": {
    "card_json": {
      "type": "调查员卡",
      "name": "约翰·史密斯",
      "body": "退役警察，拥有丰富的执法经验...",
      "class": "守护者",
      "attribute": [3, 2, 2, 3],
      "health": 8,
      "horror": 5,
      "image_prompt": "幻想风格插画，一位中年男性退役警察..."
    }
  }
}
```

## 20. 一次性生成并解析卡牌

### 基本信息

- **接口名称**: 一次性生成并解析卡牌JSON
- **请求地址**: `/api/generate-and-parse-card`
- **请求方法**: `POST`
- **功能描述**: 调用OpenAI API生成卡牌JSON信息，并自动解析验证，返回最终的卡牌数据对象（非流式）

### 请求参数

| 参数名  | 类型   | 必填 | 说明             |
| ------- | ------ | ---- | ---------------- |
| content | string | 是   | 卡牌描述文本内容 |

### 响应格式

| 字段                | 类型   | 说明                 |
| ------------------- | ------ | -------------------- |
| data.card_json      | object | 解析后的卡牌数据     |
| data.raw_response   | string | AI原始返回的文本内容 |

### 请求示例

```bash
curl -X POST /api/generate-and-parse-card \
  -H "Content-Type: application/json" \
  -d '{
    "content": "创建一个探求者调查员，名叫艾米丽·戴维斯，四维是1423，生命值6，恐惧值8，背景是考古学家"
  }'
```

### 示例响应

```json
{
  "code": 0,
  "msg": "生成并解析卡牌JSON成功",
  "data": {
    "card_json": {
      "type": "调查员卡",
      "class": "探求者",
      "name": "艾米丽·戴维斯",
      "subtitle": "考古学家",
      "attribute": [1, 4, 2, 3],
      "health": 6,
      "horror": 8,
      "traits": ["学者"],
      "body": "艾米丽是一位经验丰富的考古学家，专注于古代文明的研究...",
      "flavor": "\"历史的真相就隐藏在这些古老的遗迹中。\" —艾米丽·戴维斯",
      "image_prompt": "幻想风格插画，一位年轻的女性考古学家，穿着实用的野外工作服..."
    },
    "raw_response": "```json\n{\n  \"type\": \"调查员卡\",\n  \"class\": \"探求者\",\n..."
  }
}
```

## 配置要求

使用OpenAI相关接口需要在工作目录的`config.json`中配置以下参数：

```json
{
  "ai_api_key": "your-openai-api-key",
  "ai_endpoint": "https://api.openai.com/v1",
  "ai_model": "gpt-3.5-turbo",
  "ai_enabled_in_editor": true
}
```

### 配置参数说明

| 参数名              | 类型    | 必填 | 默认值                        | 说明                           |
| ------------------- | ------- | ---- | ----------------------------- | ------------------------------ |
| ai_api_key          | string  | 是   | -                             | OpenAI API密钥                 |
| ai_endpoint         | string  | 否   | https://api.openai.com/v1     | API服务端点URL                 |
| ai_model            | string  | 否   | gpt-3.5-turbo                 | 使用的AI模型名称               |
| ai_enabled_in_editor| boolean | 否   | false                         | 是否在编辑器中启用AI功能       |

## 提示词文件

接口依赖项目根目录`prompt`文件夹下的`player_card_picture.txt`文件作为系统提示词。该文件包含了详细的卡牌JSON格式规范和字段说明，用于指导AI生成符合要求的卡牌数据。

## 注意事项

1. **配置依赖**: 使用前需在`config.json`中正确配置OpenAI相关参数
2. **提示词文件**: 确保`prompt/player_card_picture.txt`文件存在且内容完整
3. **流式接口**: 接口18使用SSE流式输出，适合需要实时反馈的场景
4. **错误处理**: AI返回的JSON如果包含非空的`msg`字段，将被视为错误信息
5. **格式修复**: 系统会自动尝试修复常见的JSON格式问题
6. **字段验证**: 会检查必要字段（type、name、body）是否存在
7. **代码块解析**: 支持从Markdown代码块中提取JSON内容

## 错误码补充

在原有错误码基础上，新增OpenAI相关错误码：

| 错误码范围 | 分类           | 说明                         |
| ---------- | -------------- | ---------------------------- |
| 7001-7999  | OpenAI生成相关 | OpenAI卡牌生成和解析相关错误 |

### OpenAI相关错误码详细说明

| 错误码 | 说明                         |
| ------ | ---------------------------- |
| 7001   | 请提供卡牌描述内容           |
| 7002   | 无法读取提示词文件           |
| 7003   | 请在配置中设置AI API密钥     |
| 7004   | 创建OpenAI客户端失败         |
| 7005   | 生成卡牌信息失败             |
| 7006   | 请提供JSON文本               |
| 7007   | JSON格式错误                 |
| 7008   | AI返回错误                   |
| 7009   | 缺少必要字段                 |
| 7010   | 解析JSON失败                 |
| 7011   | 请提供卡牌描述内容（非流式） |
| 7012   | 无法读取提示词文件（非流式） |
| 7013   | 请在配置中设置AI API密钥（非流式） |
| 7014   | 创建OpenAI客户端失败（非流式） |
| 7015   | OpenAI API调用失败           |
| 7016   | 解析AI返回的JSON失败         |
| 7017   | AI返回错误（非流式）         |
| 7018   | 生成的JSON缺少必要字段       |
| 7019   | 生成并解析卡牌信息失败       |