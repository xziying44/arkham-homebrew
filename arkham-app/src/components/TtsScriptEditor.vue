<template>
    <n-card v-if="shouldShowTtsScript" title="üì¢ TTSËÑöÊú¨" size="small" class="form-card tts-card">
        <n-space vertical size="medium">
            <!-- IDÈÖçÁΩÆ -->
            <n-form-item label="üîñ ËÑöÊú¨ID">
                <n-space align="center">
                    <n-input v-model:value="cardConfig.id" placeholder="ËæìÂÖ•Ëá™ÂÆö‰πâIDÊàñ‰ΩøÁî®ÈöèÊú∫ÁîüÊàê" style="flex: 1"
                        @update:value="onCardConfigChange" />
                    <n-button @click="generateRandomId" size="small" type="primary">
                        üé≤ ÈöèÊú∫
                    </n-button>
                </n-space>
            </n-form-item>

            <!-- Ë∞ÉÊü•Âëò‰∏ìÁî®ÈÖçÁΩÆ -->
            <template v-if="cardType === 'Ë∞ÉÊü•Âëò'">
                <!-- È¢ùÂ§ñÊ†áËÆ∞Á±ªÂûã -->
                <n-form-item label="üè∑Ô∏è È¢ùÂ§ñÊ†áËÆ∞ÔºàÊØèËΩÆ‰∏ÄÊ¨°Ôºâ">
                    <n-select v-model:value="investigatorConfig.extraToken" :options="extraTokenOptions"
                        placeholder="ÈÄâÊã©È¢ùÂ§ñÊ†áËÆ∞Á±ªÂûã" @update:value="onCardConfigChange" />
                </n-form-item>

                <!-- ÂõõÁª¥Â±ûÊÄß -->
                <n-form-item label="üéØ ËÉΩÂäõÂÄº">
                    <n-space>
                        <div class="attribute-input">
                            <n-text depth="3" style="font-size: 12px;">üß† ÊÑèÂøó</n-text>
                            <n-input-number v-model:value="investigatorConfig.willpowerIcons" :min="0" :max="9" :step="1"
                                size="small" @update:value="onCardConfigChange" />
                        </div>
                        <div class="attribute-input">
                            <n-text depth="3" style="font-size: 12px;">üìö Êô∫Âäõ</n-text>
                            <n-input-number v-model:value="investigatorConfig.intellectIcons" :min="0" :max="9" :step="1"
                                size="small" @update:value="onCardConfigChange" />
                        </div>
                        <div class="attribute-input">
                            <n-text depth="3" style="font-size: 12px;">‚öîÔ∏è ÊàòÂäõ</n-text>
                            <n-input-number v-model:value="investigatorConfig.combatIcons" :min="0" :max="9" :step="1"
                                size="small" @update:value="onCardConfigChange" />
                        </div>
                        <div class="attribute-input">
                            <n-text depth="3" style="font-size: 12px;">‚ö° ÊïèÊç∑</n-text>
                            <n-input-number v-model:value="investigatorConfig.agilityIcons" :min="0" :max="9" :step="1"
                                size="small" @update:value="onCardConfigChange" />
                        </div>
                    </n-space>
                </n-form-item>
            </template>

            <!-- ÊîØÊè¥Âç°/‰∫ã‰ª∂Âç°‰∏ìÁî®ÈÖçÁΩÆ -->
            <template v-if="cardType === 'ÊîØÊè¥' || cardType === '‰∫ã‰ª∂'">
                <!-- Âü∫Êú¨Â±ûÊÄß -->
                <n-form-item label="üìä Âç°ÁâáÂ±ûÊÄß">
                    <n-space vertical size="small">
                        <n-space align="center">
                            <n-text depth="3">üí∞ Ë¥πÁî®:</n-text>
                            <n-input-number v-model:value="assetConfig.cost" :min="0" :max="99" :step="1"
                                size="small" style="width: 80px" @update:value="onCardConfigChange" />
                            
                            <n-text depth="3">üì∂ Á≠âÁ∫ß:</n-text>
                            <n-input-number v-model:value="assetConfig.level" :min="0" :max="5" :step="1"
                                size="small" style="width: 80px" @update:value="onCardConfigChange" />
                        </n-space>
                        
                        <!-- ÊäÄËÉΩÂõæÊ†á -->
                        <n-space>
                            <div class="attribute-input">
                                <n-text depth="3" style="font-size: 12px;">üß†</n-text>
                                <n-input-number v-model:value="assetConfig.willpowerIcons" :min="0" :max="3" :step="1"
                                    size="small" @update:value="onCardConfigChange" />
                            </div>
                            <div class="attribute-input">
                                <n-text depth="3" style="font-size: 12px;">üìö</n-text>
                                <n-input-number v-model:value="assetConfig.intellectIcons" :min="0" :max="3" :step="1"
                                    size="small" @update:value="onCardConfigChange" />
                            </div>
                            <div class="attribute-input">
                                <n-text depth="3" style="font-size: 12px;">‚öîÔ∏è</n-text>
                                <n-input-number v-model:value="assetConfig.combatIcons" :min="0" :max="3" :step="1"
                                    size="small" @update:value="onCardConfigChange" />
                            </div>
                            <div class="attribute-input">
                                <n-text depth="3" style="font-size: 12px;">‚ö°</n-text>
                                <n-input-number v-model:value="assetConfig.agilityIcons" :min="0" :max="3" :step="1"
                                    size="small" @update:value="onCardConfigChange" />
                            </div>
                            <div class="attribute-input">
                                <n-text depth="3" style="font-size: 12px;">üåü</n-text>
                                <n-input-number v-model:value="assetConfig.wildIcons" :min="0" :max="3" :step="1"
                                    size="small" @update:value="onCardConfigChange" />
                            </div>
                        </n-space>
                    </n-space>
                </n-form-item>

                <!-- Uses ÈÖçÁΩÆ -->
                <n-form-item label="üéØ Uses ÈÖçÁΩÆ">
                    <n-space vertical size="small">
                        <n-switch v-model:value="enableUses" @update:value="onUsesToggle">
                            <template #checked>ÂêØÁî® Uses</template>
                            <template #unchecked>Á¶ÅÁî® Uses</template>
                        </n-switch>

                        <div v-show="enableUses" class="uses-config">
                            <n-space vertical size="small">
                                <!-- Uses ÂàóË°® -->
                                <div v-for="(use, index) in assetConfig.uses" :key="index" class="use-config-row">
                                    <n-space align="center">
                                        <n-text depth="3">Êï∞Èáè:</n-text>
                                        <n-input-number v-model:value="use.count" :min="1" :max="99" :step="1"
                                            size="small" style="width: 80px" @update:value="onCardConfigChange" />
                                        
                                        <n-text depth="3">Á±ªÂûã:</n-text>
                                        <n-input v-model:value="use.type" placeholder="Â¶Ç: Ammo" 
                                            style="width: 100px" @update:value="onCardConfigChange" />
                                        
                                        <n-text depth="3">Token:</n-text>
                                        <n-select v-model:value="use.token" :options="tokenTypeOptions"
                                            placeholder="ÈÄâÊã©TokenÁ±ªÂûã" style="width: 120px"
                                            @update:value="onCardConfigChange" />
                                        
                                        <n-button @click="removeUse(index)" size="small" type="error" quaternary>
                                            üóëÔ∏è
                                        </n-button>
                                    </n-space>
                                </div>

                                <!-- Ê∑ªÂä† Use -->
                                <n-button @click="addUse" size="small" type="primary" dashed>
                                    ‚ûï Ê∑ªÂä† Use
                                </n-button>
                            </n-space>
                        </div>
                    </n-space>
                </n-form-item>
            </template>

            <!-- ÊØèÈò∂ÊÆµËÑöÊú¨ÈÖçÁΩÆÂºÄÂÖ≥ -->
            <n-form-item label="üéÆ ÊØèÈò∂ÊÆµÊåâÈíÆÈÖçÁΩÆ">
                <n-space vertical size="small">
                    <n-switch v-model:value="enablePhaseButtons" @update:value="onPhaseButtonToggle">
                        <template #checked>ÂêØÁî®</template>
                        <template #unchecked>Á¶ÅÁî®</template>
                    </n-switch>

                    <!-- ÊØèÈò∂ÊÆµËÑöÊú¨ÈÖçÁΩÆ -->
                    <div v-show="enablePhaseButtons" class="phase-buttons-config">
                        <n-space vertical size="small">
                            <!-- ÊåâÈíÆÂàóË°® -->
                            <div v-for="(button, index) in phaseButtonConfig.buttons" :key="index"
                                class="button-config-row">
                                <n-space align="center">
                                    <n-input v-model:value="button.id" placeholder="ÊåâÈíÆID" style="width: 120px"
                                        @update:value="onPhaseButtonConfigChange" />
                                    <n-select v-model:value="button.label" :options="buttonLabelOptions"
                                        placeholder="ÈÄâÊã©Ê†áÁ≠æ" style="width: 140px"
                                        @update:value="onPhaseButtonConfigChange" />
                                    <n-select v-model:value="button.color" :options="colorOptions" placeholder="ÈÄâÊã©È¢úËâ≤"
                                        style="width: 120px" @update:value="onPhaseButtonConfigChange">
                                        <template #label="{ option }">
                                            <div class="color-option-display">
                                                <div
                                                    :style="{ backgroundColor: option.value, width: '16px', height: '16px', borderRadius: '2px', marginRight: '8px' }">
                                                </div>
                                                <span>{{ option.label }}</span>
                                            </div>
                                        </template>
                                        <template #option="{ node, option }">
                                            <div class="color-option-display">
                                                <div
                                                    :style="{ backgroundColor: option.value, width: '16px', height: '16px', borderRadius: '2px', marginRight: '8px' }">
                                                </div>
                                                <span>{{ option.label }}</span>
                                            </div>
                                        </template>
                                    </n-select>
                                    <n-button @click="removePhaseButton(index)" size="small" type="error" quaternary>
                                        üóëÔ∏è Âà†Èô§
                                    </n-button>
                                </n-space>
                            </div>

                            <!-- Ê∑ªÂä†ÊåâÈíÆ -->
                            <n-button @click="addPhaseButton" size="small" type="primary" dashed>
                                ‚ûï Ê∑ªÂä†ÊåâÈíÆ
                            </n-button>
                        </n-space>
                    </div>
                </n-space>
            </n-form-item>

            <!-- È¢ÑËßàGMNotes -->
            <n-form-item label="üìã GMNotesÈ¢ÑËßà">
                <div class="gmnotes-preview">
                    <n-code :code="generatedGMNotes" language="json" :word-wrap="true" class="preview-code" />
                    <div class="preview-actions">
                        <n-space size="small">
                            <n-button size="tiny" @click="copyGMNotes" title="Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø">
                                üìã Â§çÂà∂
                            </n-button>
                            <n-button size="tiny" @click="regenerateGMNotes" title="ÈáçÊñ∞ÁîüÊàê">
                                üîÑ Âà∑Êñ∞
                            </n-button>
                        </n-space>
                    </div>
                </div>
            </n-form-item>
        </n-space>
    </n-card>
</template>

<script setup lang="ts">
import { ref, computed, watch, nextTick } from 'vue';
import { useMessage } from 'naive-ui';
import { v4 as uuidv4 } from 'uuid';
import {
    generatePhaseButtonScript,
    parsePhaseButtonConfig,
    defaultPhaseButtons,
    buttonLabelOptions,
    colorOptions,
    type PhaseButtonConfig,
    type PhaseButton
} from '@/config/ttsScriptGenerator';

interface Props {
    cardData: Record<string, any>;
    cardType: string;
}

interface TtsScriptData {
    GMNotes: string;
    LuaScript: string;
    config?: {
        enablePhaseButtons: boolean;
        enableUses: boolean;
        phaseButtonConfig: PhaseButtonConfig;
        investigatorConfig: InvestigatorConfig;
        assetConfig: AssetConfig;
    };
}

interface InvestigatorConfig {
    id: string;
    extraToken: string;
    willpowerIcons: number;
    intellectIcons: number;
    combatIcons: number;
    agilityIcons: number;
}

interface UseConfig {
    count: number;
    type: string;
    token: string;
}

interface AssetConfig {
    id: string;
    cost: number;
    level: number;
    willpowerIcons: number;
    intellectIcons: number;
    combatIcons: number;
    agilityIcons: number;
    wildIcons: number;
    uses: UseConfig[];
}

const props = defineProps<Props>();
const emit = defineEmits<{
    'update-tts-script': [data: TtsScriptData];
}>();

const message = useMessage();

// ÈÄöÁî®Âç°ÁâáÈÖçÁΩÆ
const cardConfig = ref({
    id: ''
});

// Ë∞ÉÊü•ÂëòTTSÈÖçÁΩÆ
const investigatorConfig = ref<InvestigatorConfig>({
    id: '',
    extraToken: 'None',
    willpowerIcons: 3,
    intellectIcons: 3,
    combatIcons: 2,
    agilityIcons: 2
});

// ÊîØÊè¥Âç°/‰∫ã‰ª∂Âç°ÈÖçÁΩÆ
const assetConfig = ref<AssetConfig>({
    id: '',
    cost: 1,
    level: 0,
    willpowerIcons: 0,
    intellectIcons: 0,
    combatIcons: 0,
    agilityIcons: 0,
    wildIcons: 0,
    uses: []
});

// Uses ÈÖçÁΩÆÂºÄÂÖ≥
const enableUses = ref(false);

// ÊØèÈò∂ÊÆµÊåâÈíÆÈÖçÁΩÆÂºÄÂÖ≥
const enablePhaseButtons = ref(false);

// ÊØèÈò∂ÊÆµÊåâÈíÆÈÖçÁΩÆ
const phaseButtonConfig = ref<PhaseButtonConfig>({
    buttons: [...defaultPhaseButtons]
});

// ËÅåÈò∂Êò†Â∞Ñ
const classMapping: Record<string, string> = {
    'ÂÆàÊä§ËÄÖ': 'Guardian',
    'Êé¢Ê±ÇËÄÖ': 'Seeker',
    'ÊµÅÊµ™ËÄÖ': 'Rogue',
    'ÊΩú‰øÆËÄÖ': 'Mystic',
    'ÁîüÂ≠òËÄÖ': 'Survivor',
    '‰∏≠Á´ã': 'Neutral'
};

// Âç°ÁâáÁ±ªÂûãÊò†Â∞Ñ
const typeMapping: Record<string, string> = {
    'Ë∞ÉÊü•Âëò': 'Investigator',
    'ÊîØÊè¥': 'Asset',
    '‰∫ã‰ª∂': 'Event'
};

// È¢ùÂ§ñÊ†áËÆ∞ÈÄâÈ°π
const extraTokenOptions = [
    { label: 'üö´ Êó†Ê†áËÆ∞', value: 'None' },
    { label: '‚≠ï ÂèçÂ∫î', value: 'Reaction' },
    { label: '‚ö° ÂÖçË¥π', value: 'FreeTrigger' }
];

// TokenÁ±ªÂûãÈÄâÈ°π
const tokenTypeOptions = [
    { label: 'üíß Resource', value: 'resource' },
    { label: 'üî´ Ammo', value: 'resource' },
    { label: 'üí∞ Bounty', value: 'resource' },
    { label: '‚ö° Charge', value: 'resource' },
    { label: 'üîç Evidence', value: 'resource' },
    { label: 'ü§´ Secret', value: 'resource' },
    { label: 'üì¶ Supply', value: 'resource' },
    { label: 'üéÅ Offering', value: 'resource' }
];

// Âà§Êñ≠ÊòØÂê¶Â∫îËØ•ÊòæÁ§∫TTSËÑöÊú¨ÁªÑ‰ª∂
const shouldShowTtsScript = computed(() => {
    const supportedTypes = ['Ë∞ÉÊü•Âëò', 'ÊîØÊè¥', '‰∫ã‰ª∂'];
    return supportedTypes.includes(props.cardType);
});

// ÁîüÊàêGMNotes
const generatedGMNotes = computed(() => {
    if (props.cardType === 'Ë∞ÉÊü•Âëò') {
        return generateInvestigatorGMNotes();
    } else if (props.cardType === 'ÊîØÊè¥' || props.cardType === '‰∫ã‰ª∂') {
        return generateAssetGMNotes();
    }
    return '';
});

// ÁîüÊàêË∞ÉÊü•ÂëòGMNotes
const generateInvestigatorGMNotes = () => {
    const gmNotesData = {
        id: cardConfig.value.id || generateUUID(),
        type: 'Investigator',
        class: classMapping[props.cardData.class || 'Êé¢Ê±ÇËÄÖ'] || 'Seeker',
        traits: (props.cardData.traits || []).join('.') + (props.cardData.traits?.length ? '.' : ''),
        willpowerIcons: investigatorConfig.value.willpowerIcons,
        intellectIcons: investigatorConfig.value.intellectIcons,
        combatIcons: investigatorConfig.value.combatIcons,
        agilityIcons: investigatorConfig.value.agilityIcons,
        extraToken: investigatorConfig.value.extraToken
    };

    try {
        return JSON.stringify(gmNotesData, null, 2);
    } catch (error) {
        return '// JSONÁîüÊàêÂ§±Ë¥•';
    }
};

// ÁîüÊàêÊîØÊè¥Âç°/‰∫ã‰ª∂Âç°GMNotes
const generateAssetGMNotes = () => {
    const gmNotesData: any = {
        id: cardConfig.value.id || generateUUID(),
        class: classMapping[props.cardData.class || '‰∏≠Á´ã'] || 'Neutral',
        type: typeMapping[props.cardType] || 'Asset',
        level: assetConfig.value.level,
        traits: (props.cardData.traits || []).join('.') + (props.cardData.traits?.length ? '.' : ''),
        cost: assetConfig.value.cost
    };

    // Ê∑ªÂä†ÊäÄËÉΩÂõæÊ†á
    if (assetConfig.value.willpowerIcons > 0) gmNotesData.willpowerIcons = assetConfig.value.willpowerIcons;
    if (assetConfig.value.intellectIcons > 0) gmNotesData.intellectIcons = assetConfig.value.intellectIcons;
    if (assetConfig.value.combatIcons > 0) gmNotesData.combatIcons = assetConfig.value.combatIcons;
    if (assetConfig.value.agilityIcons > 0) gmNotesData.agilityIcons = assetConfig.value.agilityIcons;
    if (assetConfig.value.wildIcons > 0) gmNotesData.wildIcons = assetConfig.value.wildIcons;

    // Ê∑ªÂä†UsesÈÖçÁΩÆ
    if (enableUses.value && assetConfig.value.uses.length > 0) {
        gmNotesData.uses = assetConfig.value.uses;
    }

    try {
        return JSON.stringify(gmNotesData, null, 2);
    } catch (error) {
        return '// JSONÁîüÊàêÂ§±Ë¥•';
    }
};

// ÁîüÊàêÂÆåÊï¥ÁöÑLuaËÑöÊú¨
const generatedLuaScript = computed(() => {
    if (!enablePhaseButtons.value) return '';
    return generatePhaseButtonScript(phaseButtonConfig.value);
});

// TTSËÑöÊú¨Êï∞ÊçÆÔºàÂåÖÂê´ÈÖçÁΩÆÔºâ
const ttsScriptData = computed((): TtsScriptData => ({
    GMNotes: generatedGMNotes.value,
    LuaScript: generatedLuaScript.value,
    config: {
        enablePhaseButtons: enablePhaseButtons.value,
        enableUses: enableUses.value,
        phaseButtonConfig: phaseButtonConfig.value,
        investigatorConfig: investigatorConfig.value,
        assetConfig: assetConfig.value
    }
}));

// ÁîüÊàêUUID
const generateUUID = (): string => {
    return uuidv4().replace(/-/g, '').substring(0, 8).toUpperCase();
};

// ÁîüÊàêÈöèÊú∫ID
const generateRandomId = () => {
    cardConfig.value.id = generateUUID();
    if (props.cardType === 'Ë∞ÉÊü•Âëò') {
        investigatorConfig.value.id = cardConfig.value.id;
    } else {
        assetConfig.value.id = cardConfig.value.id;
    }
    onCardConfigChange();
};

// Ê∑ªÂä†Use
const addUse = () => {
    assetConfig.value.uses.push({
        count: 2,
        type: 'Ammo',
        token: 'resource'
    });
    onCardConfigChange();
};

// Âà†Èô§Use
const removeUse = (index: number) => {
    assetConfig.value.uses.splice(index, 1);
    onCardConfigChange();
};

// UsesÂºÄÂÖ≥ÂèòÂåñÂ§ÑÁêÜ
const onUsesToggle = () => {
    nextTick(() => {
        emit('update-tts-script', ttsScriptData.value);
    });
};

// Ê∑ªÂä†Èò∂ÊÆµÊåâÈíÆ
const addPhaseButton = () => {
    phaseButtonConfig.value.buttons.push({
        id: `Button${phaseButtonConfig.value.buttons.length + 1}`,
        label: 'w',
        color: '#ffffff'
    });
    onPhaseButtonConfigChange();
};

// Âà†Èô§Èò∂ÊÆµÊåâÈíÆ
const removePhaseButton = (index: number) => {
    phaseButtonConfig.value.buttons.splice(index, 1);
    onPhaseButtonConfigChange();
};

// Âç°ÁâáÈÖçÁΩÆÂèòÂåñÂ§ÑÁêÜ
const onCardConfigChange = () => {
    nextTick(() => {
        emit('update-tts-script', ttsScriptData.value);
    });
};

// Èò∂ÊÆµÊåâÈíÆÈÖçÁΩÆÂèòÂåñÂ§ÑÁêÜ
const onPhaseButtonConfigChange = () => {
    nextTick(() => {
        emit('update-tts-script', ttsScriptData.value);
    });
};

// Èò∂ÊÆµÊåâÈíÆÂºÄÂÖ≥ÂèòÂåñÂ§ÑÁêÜ
const onPhaseButtonToggle = () => {
    nextTick(() => {
        emit('update-tts-script', ttsScriptData.value);
    });
};

// Â§çÂà∂GMNotes
const copyGMNotes = async () => {
    try {
        await navigator.clipboard.writeText(generatedGMNotes.value);
        message.success('GMNotesÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
    } catch (error) {
        message.error('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂');
    }
};

// ÈáçÊñ∞ÁîüÊàêGMNotes
const regenerateGMNotes = () => {
    onCardConfigChange();
    message.success('GMNotesÂ∑≤ÈáçÊñ∞ÁîüÊàê');
};

// ‰ªéÂç°ÁâåÊï∞ÊçÆÂêåÊ≠•Â±ûÊÄß
const syncAttributesFromCardData = () => {
    if (props.cardType === 'Ë∞ÉÊü•Âëò' && props.cardData.attribute) {
        const attributes = props.cardData.attribute;
        if (Array.isArray(attributes) && attributes.length >= 4) {
            investigatorConfig.value.willpowerIcons = attributes[0] || 3;
            investigatorConfig.value.intellectIcons = attributes[1] || 3;
            investigatorConfig.value.combatIcons = attributes[2] || 2;
            investigatorConfig.value.agilityIcons = attributes[3] || 2;
        }
    } else if ((props.cardType === 'ÊîØÊè¥' || props.cardType === '‰∫ã‰ª∂') && props.cardData) {
        // ÂêåÊ≠•Ë¥πÁî®
        if (props.cardData.cost !== undefined) {
            assetConfig.value.cost = props.cardData.cost;
        }
        // ÂêåÊ≠•Á≠âÁ∫ß
        if (props.cardData.level !== undefined) {
            assetConfig.value.level = props.cardData.level;
        }
        // ÂêåÊ≠•usesÈÖçÁΩÆ
        if (props.cardData.uses && Array.isArray(props.cardData.uses)) {
            enableUses.value = true;
            assetConfig.value.uses = [...props.cardData.uses];
        }
    }
};

// ‰ªé‰øùÂ≠òÁöÑÈÖçÁΩÆ‰∏≠Âä†ËΩΩÊï∞ÊçÆ
const loadFromSavedConfig = (savedConfig: any) => {
    console.log('üîß Âä†ËΩΩ‰øùÂ≠òÁöÑTTSÈÖçÁΩÆ:', savedConfig);
    
    if (savedConfig?.investigatorConfig) {
        const config = savedConfig.investigatorConfig;
        investigatorConfig.value = {
            id: config.id || '',
            extraToken: config.extraToken || 'None',
            willpowerIcons: config.willpowerIcons || 3,
            intellectIcons: config.intellectIcons || 3,
            combatIcons: config.combatIcons || 2,
            agilityIcons: config.agilityIcons || 2
        };
        cardConfig.value.id = config.id;
        console.log('‚úÖ Ë∞ÉÊü•ÂëòÈÖçÁΩÆÂ∑≤Âä†ËΩΩ');
    }

    if (savedConfig?.assetConfig) {
        const config = savedConfig.assetConfig;
        assetConfig.value = {
            id: config.id || '',
            cost: config.cost || 1,
            level: config.level || 0,
            willpowerIcons: config.willpowerIcons || 0,
            intellectIcons: config.intellectIcons || 0,
            combatIcons: config.combatIcons || 0,
            agilityIcons: config.agilityIcons || 0,
            wildIcons: config.wildIcons || 0,
            uses: config.uses || []
        };
        cardConfig.value.id = config.id;
        console.log('‚úÖ ÊîØÊè¥Âç°/‰∫ã‰ª∂Âç°ÈÖçÁΩÆÂ∑≤Âä†ËΩΩ');
    }

    if (savedConfig?.enableUses !== undefined) {
        enableUses.value = savedConfig.enableUses;
        console.log('‚úÖ UsesÈÖçÁΩÆÂºÄÂÖ≥Áä∂ÊÄÅÂ∑≤Âä†ËΩΩ:', enableUses.value);
    }

    if (savedConfig?.enablePhaseButtons !== undefined) {
        enablePhaseButtons.value = savedConfig.enablePhaseButtons;
        console.log('‚úÖ Èò∂ÊÆµÊåâÈíÆÂºÄÂÖ≥Áä∂ÊÄÅÂ∑≤Âä†ËΩΩ:', enablePhaseButtons.value);
    }

    if (savedConfig?.phaseButtonConfig) {
        phaseButtonConfig.value = savedConfig.phaseButtonConfig;
        console.log('‚úÖ Èò∂ÊÆµÊåâÈíÆÈÖçÁΩÆÂ∑≤Âä†ËΩΩ:', phaseButtonConfig.value.buttons.length, '‰∏™ÊåâÈíÆ');
    }
};

// ‰ªéÊóßÊï∞ÊçÆÊ†ºÂºèÂÖºÂÆπÂä†ËΩΩ
const loadFromLegacyFormat = (ttsScript: any) => {
    console.log('üîÑ ‰ΩøÁî®ÂÖºÂÆπÊ®°ÂºèÂä†ËΩΩTTSÊï∞ÊçÆ');
    
    // Â∞ùËØï‰ªéGMNotesËß£ÊûêÈÖçÁΩÆ
    if (ttsScript?.GMNotes) {
        try {
            const parsed = JSON.parse(ttsScript.GMNotes);
            cardConfig.value.id = parsed.id || '';
            
            if (props.cardType === 'Ë∞ÉÊü•Âëò') {
                investigatorConfig.value = {
                    id: parsed.id || '',
                    extraToken: parsed.extraToken || 'None',
                    willpowerIcons: parsed.willpowerIcons || 3,
                    intellectIcons: parsed.intellectIcons || 3,
                    combatIcons: parsed.combatIcons || 2,
                    agilityIcons: parsed.agilityIcons || 2
                };
            } else {
                assetConfig.value = {
                    id: parsed.id || '',
                    cost: parsed.cost || 1,
                    level: parsed.level || 0,
                    willpowerIcons: parsed.willpowerIcons || 0,
                    intellectIcons: parsed.intellectIcons || 0,
                    combatIcons: parsed.combatIcons || 0,
                    agilityIcons: parsed.agilityIcons || 0,
                    wildIcons: parsed.wildIcons || 0,
                    uses: parsed.uses || []
                };
                
                if (parsed.uses && parsed.uses.length > 0) {
                    enableUses.value = true;
                }
            }
            console.log('‚úÖ ‰ªéGMNotesËß£ÊûêÈÖçÁΩÆÊàêÂäü');
        } catch (error) {
            console.warn('‚ö†Ô∏è Ëß£ÊûêGMNotesÂ§±Ë¥•:', error);
        }
    }

    // Â¶ÇÊûúÂ≠òÂú®LuaScriptÔºåÂêØÁî®Èò∂ÊÆµÊåâÈíÆÂπ∂Â∞ùËØïËß£ÊûêÈÖçÁΩÆ
    if (ttsScript?.LuaScript) {
        enablePhaseButtons.value = true;
        const parsedConfig = parsePhaseButtonConfig(ttsScript.LuaScript);
        if (parsedConfig) {
            phaseButtonConfig.value = parsedConfig;
            console.log('‚úÖ ‰ªéLuaScriptËß£ÊûêÈò∂ÊÆµÊåâÈíÆÈÖçÁΩÆÊàêÂäü');
        }
    } else {
        enablePhaseButtons.value = false;
    }
};

// ÁõëÂê¨Âç°ÁâåÊï∞ÊçÆÂèòÂåñ
watch(
    () => props.cardData,
    () => {
        syncAttributesFromCardData();
    },
    { deep: true }
);

// ÁõëÂê¨TTSËÑöÊú¨Êï∞ÊçÆÂèòÂåñÔºåÂä†ËΩΩÈÖçÁΩÆ
watch(
    () => props.cardData.tts_script,
    (newTtsScript) => {
        console.log('üì• TTSËÑöÊú¨Êï∞ÊçÆÂèòÂåñ:', newTtsScript);
        
        if (!newTtsScript) {
            console.log('üßπ Ê≤°ÊúâTTSËÑöÊú¨Êï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§ÈÖçÁΩÆ');
            return;
        }

        // ‰ºòÂÖà‰ΩøÁî®Êñ∞Ê†ºÂºèÁöÑÈÖçÁΩÆÊï∞ÊçÆ
        if (newTtsScript.config) {
            loadFromSavedConfig(newTtsScript.config);
        } else {
            // ÂÖºÂÆπÊóßÊ†ºÂºè
            loadFromLegacyFormat(newTtsScript);
        }
        
        // Ëß¶Âèë‰∏ÄÊ¨°ÈÖçÁΩÆÊõ¥Êñ∞‰ª•Á°Æ‰øùÊï∞ÊçÆÂêåÊ≠•
        nextTick(() => {
            onCardConfigChange();
        });
    },
    { immediate: true }
);

// ÂàùÂßãÂåñ
if (shouldShowTtsScript.value) {
    nextTick(() => {
        syncAttributesFromCardData();
        onCardConfigChange();
    });
}
</script>

<style scoped>
.tts-card {
    background: linear-gradient(135deg, rgba(74, 144, 226, 0.05) 0%, rgba(80, 200, 120, 0.05) 100%);
    border: 2px solid rgba(74, 144, 226, 0.2);
}

.attribute-input {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}

.attribute-input :deep(.n-input-number) {
    width: 60px;
}

.gmnotes-preview {
    position: relative;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 6px;
    overflow: hidden;
}

.preview-code {
    max-height: 200px;
    overflow-y: auto;
    padding-right: 140px;
    padding-top: 50px;
    padding-bottom: 16px;
    padding-left: 16px;
}

.preview-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 6px;
    padding: 6px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    z-index: 10;
    backdrop-filter: blur(4px);
    min-width: 120px;
}

.phase-buttons-config {
    padding: 16px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 8px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-top: 8px;
}

.button-config-row {
    background: rgba(255, 255, 255, 0.7);
    padding: 12px;
    border-radius: 6px;
    border: 1px solid rgba(0, 0, 0, 0.05);
}

.uses-config {
    padding: 16px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 8px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-top: 8px;
}

.use-config-row {
    background: rgba(255, 255, 255, 0.7);
    padding: 12px;
    border-radius: 6px;
    border: 1px solid rgba(0, 0, 0, 0.05);
}

.color-option-display {
    display: flex;
    align-items: center;
}

@media (max-width: 768px) {
    .preview-code {
        padding-right: 16px;
        padding-top: 16px;
        padding-bottom: 60px;
    }

    .preview-actions {
        position: absolute;
        bottom: 8px;
        right: 8px;
        top: auto;
        background: rgba(245, 245, 245, 0.95);
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(4px);
        min-width: auto;
    }

    .attribute-input :deep(.n-input-number) {
        width: 50px;
    }

    .button-config-row :deep(.n-space),
    .use-config-row :deep(.n-space) {
        flex-wrap: wrap;
    }
}
</style>
